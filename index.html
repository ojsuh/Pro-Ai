<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>P.I. New 2.0 Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    <!-- Prism.js for syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <!-- JSZip for project exporting -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style id="custom-bg-style"></style>
    <style>
        /* General Styling & THEME VARIABLES */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Light Theme (Default) */
            --app-bg: #f0f2f5;
            --primary-gradient: linear-gradient(135deg, #a5b4fc, #6366f1);
            --btn-primary: #8b5cf6;
            --btn-secondary: #ec4899;
            --btn-danger: #ef4444;
            --user-msg-bg: #8b5cf6;
            --ai-msg-bg: #ffffff;
            --header-bg: #ffffff;
            --card-bg: rgba(255, 255, 255, 0.85);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --input-bg: #f3f4f6;
            --border-color: #e5e7eb;
            --sidebar-bg: #ffffff;
            --modal-bg: #ffffff;
            --code-bg: #282c34; /* okaidia theme background */
        }
        body.dark-theme {
            /* Dark Theme */
            --app-bg: #121212;
            --btn-primary: #a78bfa;
            --user-msg-bg: #7c3aed;
            --ai-msg-bg: #2d2d2d;
            --header-bg: #1e1e1e;
            --card-bg: rgba(30, 30, 30, 0.85);
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --input-bg: #374151;
            --border-color: #4b5563;
            --sidebar-bg: #1e1e1e;
            --modal-bg: #2d2d2d;
            --code-bg: #282c34;
        }
        
        /* Custom Background Styling */
        body.custom-bg-active #chat-view {
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
        body.custom-bg-active .ai-message { background-color: rgba(255, 255, 255, 0.85); }
        body.custom-bg-active .user-message { background-color: rgba(139, 92, 246, 0.9); }
        body.custom-bg-active.dark-theme .ai-message { background-color: rgba(45, 45, 45, 0.8); }
        body.custom-bg-active.dark-theme .user-message { background-color: rgba(124, 58, 237, 0.85); }


        html, body { height: 100%; overflow: hidden; }
        body.menu-open { overflow: hidden; }

        .view { display: none; width: 100%; height: 100%; position: absolute; top: 0; left: 0; overflow: hidden; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .view.active { display: flex; flex-direction: column; opacity: 1; }
        
        /* Loading Screen Animation */
        #loading-view {
            background: linear-gradient(135deg, #a5b4fc, #6366f1);
            color: white;
            justify-content: center;
            align-items: center;
            text-align: center;
            z-index: 9999;
            flex-direction: column;
        }
        .loading-animation-container {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .logo-formation {
            width: 100px;
            height: 100px;
            position: relative;
            margin-bottom: 30px;
        }
        .logo-formation .arc {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 8px solid transparent;
            position: absolute;
            top: 0;
            left: 0;
        }
        .logo-formation .arc.top {
            border-top-color: white;
            animation: rotate-arc-1 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .logo-formation .arc.bottom {
            border-bottom-color: white;
            animation: rotate-arc-2 1.2s cubic-bezier(0.68, -0.55, 0.27, 1.55) forwards;
        }
        .logo-formation .logo-text {
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 28px;
            font-weight: 800;
            color: white;
            opacity: 0;
            transform: scale(0.8);
            animation: fade-in-logo-text 0.5s ease-out 1s forwards;
        }
        .animated-title, .animated-subtitle {
            opacity: 0;
            transform: translateY(20px);
            animation: fade-in-up 0.6s ease-out 1.3s forwards;
        }
        .animated-title { font-size: 24px; font-weight: 700; margin-bottom: 5px; }
        .animated-subtitle { font-size: 16px; opacity: 0; }

        @keyframes rotate-arc-1 {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        @keyframes rotate-arc-2 {
            from { transform: rotate(70deg); }
            to { transform: rotate(430deg); }
        }
        @keyframes fade-in-logo-text {
            to { opacity: 1; transform: scale(1); }
        }
        @keyframes fade-in-up {
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- NEW LOGIN/REGISTER PAGE STYLES --- */
        #login-view {
            font-family: 'Inter', sans-serif;
            background-color: #1a1a1a;
            color: white;
            justify-content: center;
            align-items: center;
            overflow-y: auto; /* Allow scrolling on small screens */
        }
        #background-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-color: #1a1a1a; /* Fallback color */
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            transition: background-image 1.5s ease-in-out;
        }
        .form-container {
            background-color: rgba(0, 0, 0, 0.55);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .form-flipper { perspective: 1000px; }
        .form-flipper-inner { position: relative; width: 100%; height: 100%; transition: transform 0.6s; transform-style: preserve-3d; }
        .form-flipper.is-flipped .form-flipper-inner { transform: rotateY(180deg); }
        .form-face { position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden; backface-visibility: hidden; display: flex; flex-direction: column; }
        .form-back { transform: rotateY(180deg); }
        .text-shadow-lg { text-shadow: 2px 2px 4px rgba(0,0,0,0.6); }
        .password-toggle {
            position: absolute;
            right: 0.75rem;
            top: 2.375rem;
            cursor: pointer;
            color: #9ca3af;
        }
        
        /* Mobile-First Chat UI */
        #chat-view, #code-generator-view { background-color: var(--app-bg); padding: 0; overflow-y: auto; font-family: 'Nunito', sans-serif;}
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        #chat-view .app-container, #code-generator-view .app-container { padding-bottom: 15px; }
        .app-header { display: flex; align-items: center; padding: 10px 15px; background: var(--header-bg); box-shadow: 0 2px 4px rgba(0,0,0,0.05); z-index: 100; flex-shrink: 0; }
        .menu-btn, .back-btn { background: none; border: none; cursor: pointer; padding: 8px; }
        .menu-btn .material-symbols-outlined, .back-btn .material-symbols-outlined { font-size: 28px; color: var(--text-primary); }
        .header-title { flex-grow: 1; text-align: center; font-size: 16px; font-weight: 700; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* Sidebar Menu */
        .sidebar { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: var(--sidebar-bg); box-shadow: 4px 0 15px rgba(0,0,0,0.1); transform: translateX(-100%); transition: transform 0.3s ease-in-out; z-index: 1001; display: flex; flex-direction: column; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 20px; }
        .sidebar-header { padding-bottom: 20px; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; text-align: center;}
        .sidebar-header .logo { margin: 0 auto 10px; }
        .brand-text { font-size: 18px; font-weight: 700; color: var(--text-primary); }
        .model-badge { font-size: 12px; color: var(--text-secondary); }
        .sidebar-group-title { font-size: 12px; font-weight: 700; color: var(--text-secondary); text-transform: uppercase; margin-top: 20px; margin-bottom: 10px; padding: 0 15px; }
        .sidebar nav a { display: flex; align-items: center; padding: 15px; border-radius: 10px; text-decoration: none; color: var(--text-primary); font-weight: 600; margin-bottom: 10px; transition: background-color 0.2s; }
        .sidebar nav a:hover { background-color: var(--app-bg); }
        .sidebar nav a .material-symbols-outlined { margin-right: 15px; }
        .sidebar-footer { flex-shrink: 0; border-top: 1px solid var(--border-color); padding: 20px; }
        .sidebar-footer a { color: var(--text-secondary); }
        .privacy-note { font-size: 12px; color: var(--text-secondary); text-align: center; margin-top: 15px; }
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        body.menu-open .sidebar { transform: translateX(0); }
        body.menu-open .overlay { opacity: 1; visibility: visible; }

        /* Chat Messages */
        .chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 15px; }
        .message { max-width: 85%; padding: 12px 18px; border-radius: 18px; line-height: 1.5; font-size: 15px; animation: fadeIn 0.4s ease-out; display: flex; flex-direction: column; }
        .user-message { background: var(--user-msg-bg); color: white; align-self: flex-end; border-bottom-right-radius: 5px; }
        .ai-message { background: var(--ai-msg-bg); color: var(--text-primary); align-self: flex-start; border-bottom-left-radius: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .message-header { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; font-weight: 600; font-size: 13px; opacity: 0.8; }
        .user-upload-image { max-width: 100%; border-radius: 12px; margin-top: 8px; }
        .message-content img, .user-upload-image { cursor: pointer; transition: transform 0.2s; }
        .message-content img:hover, .user-upload-image:hover { transform: scale(1.03); }
        .message.loading-placeholder { flex-direction: row; align-items: center; gap: 10px; }
        .message.loading-placeholder span { font-size: 15px; font-style: italic; }
        .spinner { width: 20px; height: 20px; border: 3px solid var(--border-color); border-radius: 50%; border-top-color: var(--btn-primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Word streaming animation */
        .word-fade-in {
            display: inline-block;
            opacity: 0;
            transform: translateY(8px);
            animation: wordFadeInAnimation 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
        }
        @keyframes wordFadeInAnimation {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Code Block & Image Block Styling */
        .code-block, .image-block { background: var(--code-bg); border-radius: 12px; margin-top: 10px; overflow: hidden; }
        .code-header { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 15px; flex-wrap: wrap; }
        .code-lang { color: #cbd5e1; font-size: 14px; font-weight: bold; text-transform: capitalize; }
        .code-actions, .image-actions { display: flex; flex-wrap: wrap; gap: 8px; }
        .code-actions button, .image-actions button { background: #4a5568; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 5px; }
        .code-block pre { margin: 0 !important; background: var(--code-bg) !important; }
        .code-block pre[class*="language-"] { padding: 15px; }
        .code-block code[class*="language-"] { font-family: 'Courier New', Courier, monospace; font-size: 14px; }
        .image-block .message-content img { border-radius: 0; max-width: 100%; display: block; }
        .image-actions { padding: 10px 15px; background: rgba(0,0,0,0.2); justify-content: flex-end; }


        /* Chat Input */
        .chat-input-container { padding: 15px; padding-top: 0; background: transparent; flex-shrink: 0; }
        .input-group { display: flex; gap: 10px; align-items: center; padding: 8px; background-color: var(--header-bg); border-radius: 34px; box-shadow: 0 2px 10px rgba(0,0,0,0.08);}
        .chat-input:disabled, .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-input { flex: 1; padding: 12px 18px; border: none; background-color: transparent; color: var(--text-primary); border-radius: 28px; font-size: 17px; resize: none; max-height: 150px; }
        .chat-input:focus { outline: none; }
        .action-btn { padding: 12px; border-radius: 50%; width: 48px; height: 48px; flex-shrink: 0; background: var(--btn-primary); color: white; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .action-btn .material-symbols-outlined { font-size: 24px; }
        
        /* Image Preview in Input Area */
        .image-preview-container { position: relative; width: 70px; height: 70px; margin-left: 15px; margin-bottom: 10px; }
        #image-preview-thumbnail { width: 100%; height: 100%; border-radius: 10px; object-fit: cover; border: 2px solid var(--border-color); cursor: pointer; }
        #remove-image-btn { position: absolute; top: -8px; right: -8px; background: black; color: white; border-radius: 50%; width: 24px; height: 24px; border: 2px solid white; cursor: pointer; font-size: 16px; line-height: 20px; text-align: center; }

        /* History & Contact Pages */
        #history-view, #contact-view, #calculator-view, #education-view, #hd-enhancer-view { background-color: var(--app-bg); padding: 0; overflow-y: auto; }
        .page-header { font-size: 24px; font-weight: 700; margin-bottom: 20px; color: var(--text-primary); }
        .history-item { background: var(--header-bg); border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .history-actions button { background: var(--input-bg); color: var(--text-primary); border: 1px solid var(--border-color); padding: 8px 12px; border-radius: 8px; cursor: pointer; margin-right: 5px;}
        
        /* Calculator Page */
        .calculator-wrapper { width: 100%; max-width: 400px; margin: 0 auto; padding: 20px; }
        .calculator-display-container { width: 100%; background: var(--input-bg); color: var(--text-primary); padding: 20px; text-align: right; border-radius: 12px; margin-bottom: 20px; min-height: 120px; display: flex; flex-direction: column; justify-content: space-between; }
        .calculator-expression { font-size: 20px; color: var(--text-secondary); min-height: 24px; }
        .calculator-current-input { font-size: 48px; font-weight: 700; overflow-x: auto; white-space: nowrap; }
        .calculator-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; }
        .calc-btn { height: 70px; border-radius: 50%; border: none; font-size: 24px; cursor: pointer; background: var(--header-bg); color: var(--text-primary); transition: background-color 0.2s; }
        .calc-btn:hover { background-color: var(--input-bg); }
        .calc-btn.operator { color: var(--btn-primary); font-weight: bold; }
        .calc-btn.equals { background: var(--btn-primary); color: white; grid-column: 4; grid-row: 4 / 6; height: auto; border-radius: 40px; }
        .calc-btn.zero { grid-column: 1 / 3; border-radius: 40px; }
        .ai-calculator-section { margin-top: 40px; border-top: 1px solid var(--border-color); padding-top: 20px; }
        .ai-calculator-result { margin-top: 15px; padding: 15px; background: var(--header-bg); border-radius: 12px; min-height: 50px; line-height: 1.6; }

        /* Contact Page (Full Page) */
        #contact-view .app-container { justify-content: center; text-align: center; }
        .contact-fullpage-container { padding: 20px; }
        .contact-title-large { font-size: 48px; font-weight: 800; margin-bottom: 20px; color: var(--text-primary); }
        .contact-subtitle { font-size: 18px; color: var(--text-secondary); margin-bottom: 40px; }
        .contact-socials-large { display: flex; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .contact-socials-large .btn { width: auto; padding: 15px 30px; font-size: 18px; }
        .contact-info-large p { margin-bottom: 15px; font-size: 18px; display: flex; align-items: center; justify-content: center; gap: 10px; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 5000; padding: 20px; }
        .modal-overlay.visible { display: flex; }
        .modal-content { background: var(--modal-bg); border-radius: 16px; padding: 25px; max-width: 90vw; max-height: 90vh; width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); animation: zoomIn 0.3s ease-out; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border-color); padding-bottom: 15px; margin-bottom: 15px; }
        .modal-header h2 { color: var(--text-primary); }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-secondary); }
        .modal-body { color: var(--text-primary); overflow: auto; line-height: 1.6; }
        @keyframes zoomIn { from { transform: scale(0.9); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        
        /* --- Code Editor View Styles --- */
        #code-editor-view .app-container {
            height: 100vh; /* Full viewport height */
        }
        .code-editor-main {
            flex-grow: 1;
            display: flex;
            position: relative;
            overflow: hidden;
        }
        .code-editor-sidebar {
            position: absolute;
            top: 0;
            left: 0;
            width: 250px;
            height: 100%;
            background-color: var(--header-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            z-index: 10;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
        }
        .code-editor-main.sidebar-open .code-editor-sidebar {
            transform: translateX(0);
        }
        .sidebar-panel { padding: 10px; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .panel-title { font-weight: 700; font-size: 14px; }
        .panel-actions button { background: none; border: none; cursor: pointer; color: var(--text-primary); padding: 4px;}
        .project-list, .file-list { list-style: none; padding: 0; margin: 0; }
        .project-item, .file-item {
            padding: 10px 12px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .project-item:hover, .file-item:hover { background-color: var(--input-bg); }
        .project-item.active, .file-item.active { background-color: var(--btn-primary); color: white; }
        .item-actions { display: none; gap: 4px; }
        .project-item:hover .item-actions, .file-item:hover .item-actions { display: flex; }
        .item-actions button { background: none; border: none; cursor: pointer; color: var(--text-secondary); }
        .project-item.active .item-actions button, .file-item.active .item-actions button { color: white; }
        
        .code-editor-content {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            width: 100%;
            transition: margin-left 0.3s ease-in-out;
        }
        .code-editor-main.sidebar-open .code-editor-content {
            margin-left: 250px;
        }
        .editor-tabs {
            display: flex;
            background-color: var(--app-bg);
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        .editor-tab {
            padding: 10px 15px;
            cursor: pointer;
            border-right: 1px solid var(--border-color);
            background-color: var(--input-bg);
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            white-space: nowrap;
        }
        .editor-tab.active {
            background-color: var(--header-bg);
            color: var(--text-primary);
        }
        .editor-tab .error-indicator {
            color: var(--btn-danger);
            font-weight: bold;
            display: none; /* Hidden by default */
        }
        .editor-tab.has-error .error-indicator { display: inline; }
        .editor-container {
            flex-grow: 1;
            position: relative;
            background-color: var(--code-bg);
        }
        #main-code-editor {
            width: 100%;
            height: 100%;
            border: none;
            outline: none;
            background-color: transparent;
            color: #f8f8f2;
            font-family: 'Courier New', Courier, monospace;
            font-size: 16px;
            padding: 15px;
            resize: none;
            line-height: 1.5;
        }
        .editor-info-tip {
            padding: 10px 15px;
            font-size: 13px;
            background-color: var(--input-bg);
            color: var(--text-secondary);
            text-align: center;
        }
        
        /* Full Page Preview Overlay */
        #full-preview-overlay {
            z-index: 4000;
        }
        #full-preview-iframe {
            flex-grow: 1;
            border: none;
            background-color: white;
        }

        /* Kamera Pro & Direct Camera View */
        #camera-pro-view, #direct-camera-view {
            background-color: #000;
            z-index: 6000;
        }
        .camera-container {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .camera-video-wrapper {
            position: relative;
            width: 100%;
            flex-grow: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #camera-grid-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        .camera-preview-canvas {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            display: none;
        }
        .camera-top-controls {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.5), transparent);
        }
        .camera-controls {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            background: linear-gradient(to top, rgba(0,0,0,0.7), transparent);
        }
        .camera-modes {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            color: white;
            font-weight: 600;
        }
        .camera-mode {
            cursor: pointer;
            opacity: 0.7;
        }
        .camera-mode.active {
            opacity: 1;
            color: #facc15; /* yellow */
        }
        .capture-btn-container {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .capture-btn {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background-color: #fff;
            border: 5px solid rgba(255,255,255,0.5);
            cursor: pointer;
        }
        .confirm-controls {
            gap: 20px;
            display: none;
        }
        .camera-zoom-slider {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            writing-mode: vertical-lr;
            direction: rtl;
            width: 30px;
            height: 150px;
        }
        .cam-btn {
            background: rgba(0,0,0,0.3);
            border: none;
            color: white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
        }

        /* Education View */
        #education-view .app-container { padding: 20px; }
        .edu-section {
            background-color: var(--header-bg);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .edu-section h3 { margin-bottom: 15px; }
        .edu-section p { line-height: 1.7; margin-bottom: 15px; }
        .edu-section pre {
            background-color: var(--input-bg);
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
            word-wrap: break-word;
            font-family: 'Courier New', Courier, monospace;
        }
        .edu-section .prompt-example { border-left: 4px solid var(--btn-primary); }
        .edu-section .coba-prompt-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 15px;
            margin-top: 10px;
            font-size: 14px;
            width: auto;
        }

        /* HD Enhancer View */
        #hd-enhancer-view .app-container { padding: 20px; overflow-y: auto; }
        .enhancer-wrapper { max-width: 800px; margin: 0 auto; width: 100%; }
        .upload-area {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            background-color: var(--header-bg);
            transition: background-color 0.2s;
        }
        .upload-area:hover { background-color: var(--input-bg); }
        .upload-area .material-symbols-outlined { font-size: 48px; color: var(--btn-primary); }
        .upload-area p { color: var(--text-secondary); margin-top: 10px; }
        
        .preview-area { margin-top: 20px; display: none; }
        .preview-grid { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 768px) {
            .preview-grid { grid-template-columns: 1fr 1fr; }
        }
        .preview-box { background-color: var(--header-bg); border-radius: 12px; padding: 10px; }
        .preview-box h3 { text-align: center; margin-bottom: 10px; font-weight: 700; }
        .preview-media-container {
            width: 100%;
            background-color: var(--code-bg);
            border-radius: 8px;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            aspect-ratio: 16 / 9;
        }
        .preview-media-container video, .preview-media-container canvas, .preview-media-container img {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
        }

        .controls-area {
            margin-top: 20px;
            background-color: var(--header-bg);
            padding: 20px;
            border-radius: 12px;
        }
        .controls-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
         @media (min-width: 768px) {
            .controls-grid { grid-template-columns: 1fr 1fr; }
        }
        .control-group label { font-weight: 600; margin-bottom: 10px; display: block; }
        .quality-options { display: flex; flex-wrap: wrap; gap: 10px; }
        .quality-options label {
            padding: 8px 16px;
            border: 2px solid var(--border-color);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }
        .quality-options input[type="radio"] { display: none; }
        .quality-options input[type="radio"]:checked + label {
            background-color: var(--btn-primary);
            color: white;
            border-color: var(--btn-primary);
        }
        .toggle-switch { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            background-color: var(--input-bg);
            padding: 10px;
            border-radius: 25px;
        }
        .toggle-switch input[type="checkbox"] {
            height: 0;
            width: 0;
            visibility: hidden;
        }
        .toggle-switch label {
            cursor: pointer;
            text-indent: -9999px;
            width: 50px;
            height: 28px;
            background: grey;
            display: block;
            border-radius: 100px;
            position: relative;
            margin: 0;
        }
        .toggle-switch label:after {
            content: '';
            position: absolute;
            top: 2px;
            left: 2px;
            width: 24px;
            height: 24px;
            background: #fff;
            border-radius: 90px;
            transition: 0.3s;
        }
        .toggle-switch input:checked + label {
            background: var(--btn-primary);
        }
        .toggle-switch input:checked + label:after {
            left: calc(100% - 2px);
            transform: translateX(-100%);
        }
        .toggle-switch span { font-weight: normal; }
        
        #processing-status {
            margin-top: 20px;
            display: none;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        #processing-progress-bar-container {
            width: 100%;
            height: 8px;
            background-color: var(--input-bg);
            border-radius: 4px;
            overflow: hidden;
        }
        #processing-progress-bar {
            width: 0%;
            height: 100%;
            background-color: var(--btn-primary);
            transition: width 0.3s;
        }
        #processing-text { color: var(--text-secondary); font-size: 14px; }

    </style>
</head>
<body>
    <div id="app-root"></div>
    <input type="file" id="custom-bg-input" accept="image/*" style="display: none;">
    
    <!-- Supabase Client Library -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- SUPABASE INITIALIZATION ---
        const supabaseUrl = 'https://phkyhpgfafyaifqfttsb.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InBoa3locGdmYWZ5YWlmcWZ0dHNiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM2MjI0NzQsImV4cCI6MjA2OTE5ODQ3NH0.1koIZHyefLr5dJ_LxA2ZI4Q8KeWml4RCtrlnMesFie4';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- APP INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            const appRoot = document.getElementById('app-root');
            // Initial HTML structure is injected here
            appRoot.innerHTML = `
                <div id="loading-view" class="view active">
                    <div class="loading-animation-container">
                        <div class="logo-formation">
                            <div class="arc top"></div>
                            <div class="arc bottom"></div>
                            <div class="logo-text">PI</div>
                        </div>
                        <div class="animated-title">P.I. New 2.0 Pro</div>
                        <div class="animated-subtitle">By Paong</div>
                    </div>
                </div>
                <div class="sidebar" id="sidebar-menu">
                    <div class="sidebar-content">
                        <div class="sidebar-header">
                            <div class="logo">PI</div>
                            <div class="brand-text">P.I. New</div>
                            <div class="model-badge">2.0 Pro</div>
                        </div>
                        <nav>
                            <div class="sidebar-group-title">Utama</div>
                            <a href="#" id="menu-chat-btn"><span class="material-symbols-outlined">chat</span>Chat Utama</a>
                            <a href="#" id="menu-code-editor-btn"><span class="material-symbols-outlined">terminal</span>Editor Kode</a>
                            <a href="#" id="menu-code-generator-btn"><span class="material-symbols-outlined">code</span>Generator Kode</a>
                            <div class="sidebar-group-title">Alat Kreatif</div>
                            <a href="#" id="menu-hd-enhancer-btn"><span class="material-symbols-outlined">hd</span>HD Enhancer</a>
                            <a href="#" id="menu-camera-pro-btn"><span class="material-symbols-outlined">photo_camera</span>Kamera Pro</a>
                            <a href="#" id="menu-education-btn"><span class="material-symbols-outlined">school</span>Edukasi Prompt</a>
                            <a href="#" id="menu-history-btn"><span class="material-symbols-outlined">history</span>Riwayat</a>
                            <a href="#" id="menu-calculator-btn"><span class="material-symbols-outlined">calculate</span>Kalkulator</a>
                            <div class="sidebar-group-title">Lainnya</div>
                            <a href="#" id="menu-contact-btn"><span class="material-symbols-outlined">contact_support</span>Kontak</a>
                        </nav>
                    </div>
                    <div class="sidebar-footer">
                         <a href="#" id="menu-custom-bg-btn"><span class="material-symbols-outlined">image</span>Ubah Latar</a>
                         <a href="#" id="menu-remove-bg-btn" style="display: none;"><span class="material-symbols-outlined">hide_image</span>Hapus Latar</a>
                         <a href="#" id="theme-toggle-btn"><span class="material-symbols-outlined">contrast</span>Ganti Tema</a>
                         <a href="#" id="menu-logout-btn"><span class="material-symbols-outlined">logout</span>Logout</a>
                         <p class="privacy-note">Semua data Anda disimpan aman di perangkat ini.</p>
                    </div>
                </div>
                <div class="overlay" id="overlay"></div>
                <!-- Standard Modal -->
                <div id="modal" class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2 id="modal-title"></h2>
                            <button id="modal-close-btn" class="modal-close-btn">&times;</button>
                        </div>
                        <div id="modal-body" class="modal-body"></div>
                        <div id="modal-footer" style="margin-top: 20px; text-align: right;"></div>
                    </div>
                </div>
                
                <!-- NEW LOGIN VIEW -->
                <div id="login-view" class="view">
                    <div id="background-container"></div>
                    <div class="flex flex-col items-center justify-center min-h-screen w-full text-white p-4" style="z-index: 1;">
                        <div class="mb-5 flex items-center justify-center w-20 h-20 bg-white/20 rounded-full border-2 border-white/50 shadow-lg">
                            <span class="text-4xl font-bold text-white text-shadow-lg">PI</span>
                        </div>
                        <div class="text-center mb-5">
                            <h1 id="greeting" class="text-3xl sm:text-4xl font-bold text-shadow-lg"></h1>
                            <p id="clock" class="text-lg sm:text-xl mt-2 text-shadow-lg"></p>
                        </div>
                        
                        <div id="message-box" class="w-full max-w-md p-3 mb-4 text-center text-white rounded-lg hidden transition-opacity duration-300"></div>

                        <div class="w-full max-w-md form-flipper" id="flipper">
                            <div class="form-flipper-inner">
                                <!-- Form Login -->
                                <div class="form-face">
                                    <div class="form-container p-6 sm:p-8 rounded-2xl shadow-2xl w-full">
                                        <h2 class="text-2xl font-bold text-center mb-6 text-white">Login</h2>
                                        <form id="loginForm">
                                            <div class="mb-4">
                                                <label for="loginEmail" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                                                <input type="email" id="loginEmail" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                            </div>
                                            <div class="mb-6 relative">
                                                <label for="loginPassword" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                                                <input type="password" id="loginPassword" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                                <span class="material-symbols-outlined password-toggle">visibility_off</span>
                                            </div>
                                            <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Masuk</button>
                                        </form>
                                        <p class="text-center text-sm mt-6 text-gray-400">
                                            Belum punya akun? <a href="#" id="showRegister" class="font-medium text-blue-400 hover:underline">Daftar di sini</a>
                                        </p>
                                    </div>
                                </div>
                                <!-- Form Daftar -->
                                <div class="form-face form-back">
                                    <div class="form-container p-6 sm:p-8 rounded-2xl shadow-2xl w-full">
                                        <h2 class="text-2xl font-bold text-center mb-6 text-white">Daftar</h2>
                                        <form id="registerForm">
                                            <div class="mb-4">
                                                <label for="registerEmail" class="block mb-2 text-sm font-medium text-gray-300">Email</label>
                                                <input type="email" id="registerEmail" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                            </div>
                                            <div class="mb-4">
                                                <label for="registerUsername" class="block mb-2 text-sm font-medium text-gray-300">Username</label>
                                                <input type="text" id="registerUsername" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                            </div>
                                            <div class="mb-4 relative">
                                                <label for="registerPassword" class="block mb-2 text-sm font-medium text-gray-300">Password</label>
                                                <input type="password" id="registerPassword" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                                <span class="material-symbols-outlined password-toggle">visibility_off</span>
                                            </div>
                                             <div class="mb-4 relative">
                                                <label for="registerConfirm" class="block mb-2 text-sm font-medium text-gray-300">Konfirmasi Password</label>
                                                <input type="password" id="registerConfirm" class="w-full px-4 py-2 bg-gray-700/50 border border-gray-500 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-white" required>
                                                <span class="material-symbols-outlined password-toggle">visibility_off</span>
                                            </div>
                                            <button type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Buat Akun</button>
                                        </form>
                                        <button type="button" id="showLogin" class="w-full mt-4 bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                                            Kembali ke Login
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <div id="chat-view" class="view">
                    <div class="app-container">
                        <header class="app-header">
                            <button class="menu-btn" id="hamburger-btn"><span class="material-symbols-outlined">menu</span></button>
                            <div class="header-title" id="chat-title">P.I. New</div>
                            <button id="chat-new-chat-btn" class="menu-btn" title="Chat Baru"><span class="material-symbols-outlined">add</span></button>
                        </header>
                        <main class="chat-messages" id="chat-messages"></main>
                        <footer class="chat-input-container">
                            <div id="image-preview-container" class="image-preview-container" style="display: none;">
                                <img id="image-preview-thumbnail" src="" alt="Image preview"/>
                                <button id="remove-image-btn" class="remove-image-btn">&times;</button>
                            </div>
                            <div class="input-group">
                                <button id="upload-btn" class="action-btn" title="Unggah gambar"><span class="material-symbols-outlined">add_photo_alternate</span></button>
                                <button id="direct-camera-btn" class="action-btn" title="Ambil Foto" style="background-color: var(--btn-secondary);"><span class="material-symbols-outlined">photo_camera</span></button>
                                <textarea id="chat-input" class="chat-input" placeholder="Ketik pesan..." rows="1"></textarea>
                                <button id="send-btn" class="action-btn" title="Kirim"><span class="material-symbols-outlined">send</span></button>
                            </div>
                            <input type="file" id="file-input" accept="image/*" style="display: none">
                        </footer>
                    </div>
                </div>
                <div id="code-generator-view" class="view">
                    <div class="app-container">
                        <header class="app-header">
                            <button class="back-btn" id="back-to-chat-from-coder"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">Generator Kode</h1>
                            <button id="code-generator-clear-btn" class="menu-btn" title="Hapus Riwayat Kode"><span class="material-symbols-outlined">delete_sweep</span></button>
                        </header>
                        <main class="chat-messages" id="code-generator-messages"></main>
                        <footer class="chat-input-container">
                            <div class="input-group">
                                <textarea id="code-generator-input" class="chat-input" placeholder="Minta kode apa saja..." rows="1"></textarea>
                                <button id="code-generator-send-btn" class="action-btn" title="Kirim"><span class="material-symbols-outlined">send</span></button>
                            </div>
                        </footer>
                    </div>
                </div>
                <div id="code-editor-view" class="view">
                    <div class="app-container">
                        <header class="app-header">
                            <button class="back-btn" id="back-to-main-from-editor"><span class="material-symbols-outlined">arrow_back</span></button>
                            <button class="menu-btn" id="editor-menu-toggle-btn"><span class="material-symbols-outlined">menu</span></button>
                            <h1 class="header-title" id="code-editor-title">Editor Kode</h1>
                            <button id="run-code-btn" class="menu-btn" title="Jalankan Kode"><span class="material-symbols-outlined">play_arrow</span></button>
                        </header>
                        <main id="code-editor-main" class="code-editor-main">
                            <aside class="code-editor-sidebar">
                                <div class="sidebar-panel" style="border-bottom: 1px solid var(--border-color);">
                                    <div class="panel-header">
                                        <span class="panel-title">PROYEK</span>
                                        <div class="panel-actions">
                                            <button id="export-project-btn" title="Ekspor Proyek (.zip)"><span class="material-symbols-outlined">download</span></button>
                                            <button id="add-project-btn" title="Proyek Baru"><span class="material-symbols-outlined">create_new_folder</span></button>
                                        </div>
                                    </div>
                                    <ul id="project-list" class="project-list"></ul>
                                </div>
                                <div class="sidebar-panel" style="flex-grow: 1; display: flex; flex-direction: column;">
                                    <div class="panel-header">
                                        <span class="panel-title">BERKAS</span>
                                        <div class="panel-actions">
                                            <button id="add-file-btn" title="Berkas Baru"><span class="material-symbols-outlined">note_add</span></button>
                                        </div>
                                    </div>
                                    <ul id="file-list" class="file-list" style="flex-grow: 1; overflow-y: auto;"></ul>
                                </div>
                            </aside>
                            <div class="code-editor-content">
                                <div id="editor-tabs" class="editor-tabs"></div>
                                <div class="editor-container">
                                    <textarea id="main-code-editor" spellcheck="false"></textarea>
                                </div>
                                <div class="editor-info-tip">
                                     **Tip:** Fitur 'Jalankan' hanya untuk pratinjau proyek web (HTML, CSS, JS).
                                </div>
                            </div>
                        </main>
                    </div>
                </div>
                <div id="full-preview-overlay" class="view">
                     <header class="app-header">
                        <button class="back-btn" id="close-full-preview-btn"><span class="material-symbols-outlined">close</span></button>
                        <h1 class="header-title" id="full-preview-title">Pratinjau</h1>
                        <button id="refresh-preview-btn" class="menu-btn" title="Muat Ulang Pratinjau"><span class="material-symbols-outlined">refresh</span></button>
                    </header>
                    <iframe id="full-preview-iframe"></iframe>
                </div>
                <div id="history-view" class="view">
                    <div class="app-container" style="padding: 20px;">
                        <header class="app-header" style="position: static; margin-bottom: 20px;">
                            <button class="back-btn" id="back-to-chat-from-history"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">Riwayat Percakapan</h1>
                            <div style="width: 44px;"></div>
                        </header>
                        <div id="history-list" style="width: 100%;"></div>
                    </div>
                </div>
                 <div id="education-view" class="view">
                    <div class="app-container">
                        <header class="app-header">
                            <button class="back-btn" id="back-to-main-from-education"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">Edukasi Prompt</h1>
                            <div style="width: 44px;"></div>
                        </header>
                        <div style="padding: 20px; overflow-y: auto; flex-grow: 1;">
                            <h2 class="page-header">Cara Memberi Perintah AI yang Efektif</h2>
                            <div class="edu-section">
                                <h3>Prinsip Inti</h3>
                                <p>Untuk mendapatkan hasil terbaik dari AI, ingatlah empat hal ini: <strong>Jelas, Konteks, Persona, dan Format</strong>. Semakin baik Anda memberi instruksi, semakin baik pula hasil yang akan Anda dapatkan.</p>
                            </div>
                            <div class="edu-section">
                                <h3>Contoh 1: Meminta Kode</h3>
                                <p><strong> Kurang Efektif:</strong></p>
                                <pre>buatkan saya kode tombol</pre>
                                <p><strong> Jauh Lebih Baik:</strong></p>
                                <pre class="prompt-example">Buatkan saya kode HTML dan CSS untuk sebuah tombol login berwarna biru dengan sudut membulat. Saat kursor diarahkan ke tombol, warnanya harus berubah menjadi biru yang lebih gelap.</pre>
                                <button class="btn coba-prompt-btn" data-target="code-generator-view" data-prompt="Buatkan saya kode HTML dan CSS untuk sebuah tombol login berwarna biru dengan sudut membulat. Saat kursor diarahkan ke tombol, warnanya harus berubah menjadi biru yang lebih gelap."><span class="material-symbols-outlined">play_circle</span> Coba Prompt Ini</button>
                            </div>
                             <div class="edu-section">
                                <h3>Contoh 2: Menulis Cerita</h3>
                                <p><strong> Kurang Efektif:</strong></p>
                                <pre>cerita tentang luar angkasa</pre>
                                <p><strong> Jauh Lebih Baik:</strong></p>
                                <pre class="prompt-example">Tulis sebuah cerita pendek untuk anak-anak tentang seorang astronot muda bernama Elara yang berteman dengan alien bercahaya di planet Mars. Gunakan gaya bahasa yang ceria dan mudah dimengerti.</pre>
                                <button class="btn coba-prompt-btn" data-target="chat-view" data-prompt="Tulis sebuah cerita pendek untuk anak-anak tentang seorang astronot muda bernama Elara yang berteman dengan alien bercahaya di planet Mars. Gunakan gaya bahasa yang ceria dan mudah dimengerti."><span class="material-symbols-outlined">play_circle</span> Coba Prompt Ini</button>
                            </div>
                            <div class="edu-section">
                                <h3>Contoh 3: Membuat Gambar</h3>
                                <p><strong> Kurang Efektif:</strong></p>
                                <pre>/gambar naga</pre>
                                <p><strong> Jauh Lebih Baik:</strong></p>
                                <pre class="prompt-example">/gambar seekor naga megah berwarna biru kristal sedang tidur di puncak gunung bersalju, dengan gaya seni fantasi yang detail dan pencahayaan dramatis.</pre>
                                 <button class="btn coba-prompt-btn" data-target="chat-view" data-prompt="/gambar seekor naga megah berwarna biru kristal sedang tidur di puncak gunung bersalju, dengan gaya seni fantasi yang detail dan pencahayaan dramatis."><span class="material-symbols-outlined">play_circle</span> Coba Prompt Ini</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="contact-view" class="view">
                    <div class="app-container">
                         <header class="app-header" style="position: static;">
                            <button class="back-btn" id="back-to-chat-from-contact"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">Kontak</h1>
                            <div style="width: 44px;"></div>
                        </header>
                        <div class="contact-fullpage-container">
                            <h1 class="contact-title-large">P.I. New by Paong</h1>
                            <p class="contact-subtitle">Terhubung dengan kami melalui media sosial.</p>
                            <div class="contact-socials-large">
                                <a href="https://discord.gg/kWNfvXFN" target="_blank" class="btn" style="background: #5865F2;">Join Discord</a>
                                <a href="https://www.tiktok.com/@pinewaioficial?_t=ZS-8yGrl19Ny4n&_r=1" target="_blank" class="btn" style="background: black;">TikTok</a>
                            </div>
                            <div class="contact-info-large">
                                <p><span class="material-symbols-outlined">call</span> +62 882-2670-5434</p>
                                <p><span class="material-symbols-outlined">email</span> bypaongpinew@gmail.com</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="calculator-view" class="view">
                    <div class="app-container" style="padding: 20px;">
                         <header class="app-header" style="position: static; margin-bottom: 20px;">
                            <button class="back-btn" id="back-to-chat-from-calculator"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">Kalkulator</h1>
                            <div style="width: 44px;"></div>
                        </header>
                        <div class="calculator-wrapper">
                            <div class="calculator-display-container">
                                <div id="calculator-expression" class="calculator-expression"></div>
                                <div id="calculator-current-input" class="calculator-current-input">0</div>
                            </div>
                            <div class="calculator-grid">
                                <button class="calc-btn operator">C</button><button class="calc-btn operator">%</button><button class="calc-btn operator"></button><button class="calc-btn operator"></button>
                                <button class="calc-btn">7</button><button class="calc-btn">8</button><button class="calc-btn">9</button><button class="calc-btn operator"></button>
                                <button class="calc-btn">4</button><button class="calc-btn">5</button><button class="calc-btn">6</button><button class="calc-btn operator">-</button>
                                <button class="calc-btn">1</button><button class="calc-btn">2</button><button class="calc-btn">3</button><button class="calc-btn operator">+</button>
                                <button class="calc-btn zero">0</button><button class="calc-btn">,</button><button class="calc-btn equals">=</button>
                            </div>
                            <div class="ai-calculator-section">
                                <h2 class="page-header" style="font-size: 20px; text-align: center;">Kalkulator AI Pintar</h2>
                                <p style="text-align: center; margin-bottom: 15px; color: var(--text-secondary);">Unggah gambar soal matematika Anda</p>
                                <button id="ai-calc-upload-btn" class="btn"><span class="material-symbols-outlined">photo_camera</span>Unggah Soal</button>
                                <input type="file" id="ai-calc-file-input" accept="image/*" style="display: none;">
                                <div id="ai-calculator-result" class="ai-calculator-result">Hasil analisis AI akan muncul di sini...</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="camera-pro-view" class="view">
                    <div class="camera-container">
                        <div class="camera-video-wrapper">
                            <video id="camera-pro-video" class="camera-video" autoplay playsinline></video>
                            <canvas id="camera-grid-overlay"></canvas>
                        </div>
                        <canvas id="camera-pro-preview-canvas" class="camera-preview-canvas"></canvas>
                        <div class="camera-top-controls">
                            <button id="close-camera-pro-btn" class="cam-btn"><span class="material-symbols-outlined">close</span></button>
                            <button id="flash-pro-btn" class="cam-btn"><span class="material-symbols-outlined">flash_off</span></button>
                            <button id="grid-pro-btn" class="cam-btn"><span class="material-symbols-outlined">grid_off</span></button>
                        </div>
                        <input type="range" id="zoom-pro-slider" class="camera-zoom-slider" style="display: none;">
                        <div class="camera-controls">
                            <div class="camera-modes" id="camera-pro-modes">
                                <span class="camera-mode" data-mode="FOTO">FOTO</span>
                                <span class="camera-mode" data-mode="POTRET">POTRET</span>
                            </div>
                            <div id="capture-pro-controls" class="capture-btn-container">
                                 <button id="capture-pro-btn" class="capture-btn"></button>
                            </div>
                            <div id="confirm-pro-controls" class="confirm-controls">
                                <button id="retake-pro-btn" class="btn btn-danger"><span class="material-symbols-outlined">refresh</span> Ulangi</button>
                                <button id="download-pro-btn" class="btn"><span class="material-symbols-outlined">download</span> Unduh</button>
                            </div>
                        </div>
                    </div>
                </div>
                <div id="direct-camera-view" class="view">
                    <div class="camera-container">
                        <video id="direct-camera-video" class="camera-video" autoplay playsinline></video>
                        <canvas id="direct-camera-canvas" class="camera-preview-canvas"></canvas>
                        <div class="camera-controls">
                            <div id="capture-direct-controls">
                                 <button id="capture-direct-btn" class="capture-btn"></button>
                            </div>
                            <div id="confirm-direct-controls" class="confirm-controls">
                                <button id="retake-direct-btn" class="btn btn-danger"><span class="material-symbols-outlined">refresh</span> Ulangi</button>
                                <button id="use-photo-btn" class="btn"><span class="material-symbols-outlined">check</span> Gunakan Foto</button>
                            </div>
                        </div>
                         <button id="close-direct-camera-btn" class="back-btn" style="position: absolute; top: 10px; left: 10px; background: rgba(0,0,0,0.3); border-radius: 50%;"><span class="material-symbols-outlined" style="color: white;">close</span></button>
                    </div>
                </div>
                <div id="hd-enhancer-view" class="view">
                     <div class="app-container">
                        <header class="app-header">
                            <button class="back-btn" id="back-to-main-from-enhancer"><span class="material-symbols-outlined">arrow_back</span></button>
                            <h1 class="header-title">HD Enhancer</h1>
                            <div style="width: 44px;"></div>
                        </header>
                        <div class="enhancer-wrapper">
                            <div id="enhancer-upload-area" class="upload-area">
                                <span class="material-symbols-outlined">upload_file</span>
                                <p><strong>Klik untuk mengunggah foto atau video</strong></p>
                                <p style="font-size: 14px;">AI akan meningkatkan kualitasnya secara otomatis.</p>
                            </div>
                            <input type="file" id="enhancer-file-input" accept="image/*,video/*" style="display: none;">

                            <div id="enhancer-preview-area" class="preview-area">
                                <div class="preview-grid">
                                    <div class="preview-box">
                                        <h3>Asli</h3>
                                        <div class="preview-media-container" id="original-media-container">
                                            <video id="enhancer-original-video" playsinline muted loop style="display:none;"></video>
                                            <img id="enhancer-original-image" style="display:none;" />
                                        </div>
                                    </div>
                                    <div class="preview-box">
                                        <h3>Ditingkatkan (Pratinjau)</h3>
                                        <div class="preview-media-container">
                                            <canvas id="enhancer-ai-preview"></canvas>
                                        </div>
                                    </div>
                                </div>
                                <div class="controls-area">
                                    <div class="controls-grid">
                                        <div class="control-group">
                                            <label>Kualitas Ekspor</label>
                                            <div class="quality-options">
                                                <input type="radio" name="quality" id="q_480p" value="480"><label for="q_480p">480p</label>
                                                <input type="radio" name="quality" id="q_720p" value="720" checked><label for="q_720p">720p</label>
                                                <input type="radio" name="quality" id="q_1080p" value="1080"><label for="q_1080p">1080p</label>
                                            </div>
                                        </div>
                                        <div class="control-group" id="stabilization-control-group" style="display:none;">
                                            <label>Opsi Video</label>
                                            <div class="toggle-switch">
                                                <input type="checkbox" id="stabilize-toggle">
                                                <label for="stabilize-toggle">Stabilizer</label>
                                                <span>AI Video Stabilizer</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div style="display: flex; gap: 10px; margin-top: 20px;">
                                        <button id="change-media-btn" class="btn btn-secondary" style="background-color: var(--text-secondary); flex-grow: 1;"><span class="material-symbols-outlined">swap_horiz</span>Ganti Media</button>
                                        <button id="process-enhancer-btn" class="btn" style="flex-grow: 2;"><span class="material-symbols-outlined">rocket_launch</span>Proses & Unduh</button>
                                    </div>
                                    <div id="processing-status">
                                        <div id="processing-progress-bar-container"><div id="processing-progress-bar"></div></div>
                                        <span id="processing-text">Memproses...</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            const app = {};
            window.app = app;
            
            // --- APP STATE ---
            app.currentUser = null; // This will now be the Supabase user ID
            let isAIThinking = false;
            let currentChat = null;
            let currentCodeChat = null;
            let uploadedImageBase64 = null;
            let codeProjects = [];
            let currentProject = null;
            let currentFile = null;
            let openFiles = [];
            app.pendingCodeImport = null; // Holds {code, lang} from generator
            
            // --- CAMERA STATE ---
            let cameraPro = {
                stream: null,
                videoTrack: null,
                capabilities: {},
                settings: {},
                flashMode: 'off',
                zoomValue: 1,
                isGridVisible: false,
                currentMode: 'FOTO'
            };
            let directCameraStream = null;
            
            // --- HD ENHANCER STATE ---
            let enhancerState = {
                sourceFile: null,
                sourceType: null, // 'image' or 'video'
                sourceElement: null,
                previewCanvas: null,
                previewCtx: null,
                animationFrameId: null,
                isRendering: false,
            };


            // --- API KEYS & CONFIGURATION ---
            const GEMINI_API_KEYS = [
                "AIzaSyC7oQxORL-VoE7psJs5iXbRYUx2JUNPSC0",
                "AIzaSyAmD2ZIZDjs0LdqqRb77HjRFQyXtdyzeCw",
                "AIzaSyAt7wdqsFbmdRjC1-PGP7SNlMFk2dxSvuQ",
                "AIzaSyB6l7YbLBLEAdQrV8jysPk-4Uyio4m27jo",
                "AIzaSyDkacaBZIRZpDHRKXuIKmEdrev-LSkKa5A",
                "AIzaSyBIXKwrs0BaybchqgFko79ezDbre2IYpyM"
            ];
            const STABILITY_API_KEYS = [
                "sk-4xHagIKbTQIrSNWerz5uWQvw2tkpgGwflac6rKw0RCjiFvdc", // User's provided key
                "sk-EFvGN5TYubZGm50dads9GRtiEYRejmw2xiqV0unBAmZXPalb",
                "sk-8JXUwdq4V0jFYHodXpD6n02lQhMaHedV2eNkRPdU1jL4aTtL",
                "sk-zxSF4xntZ7eprEzkJo8ejRmIKSYkKilTem0e7EOtcKAj4PXG",
                "sk-meZzTuqZevORSNwPlHFUm38uJwdDGTexCx8XFJDWdv2P0Th2",
                "sk-XJfxit1Yys7FDsNZJ4FdlXamz1qUrP6brjdp7ntzTEbDJY7Z",
                "sk-uPhKfzLcA2nu9MrwGU1mZBNm5w39t9O66INSVOfwOzgMsmka",
                "sk-J2oExpUKFrUYKBUQETNLi4EmWbeWaQLcOGTWfob5TdFdwqUO"
            ];
            let currentGeminiKeyIndex = 0;
            let currentStabilityKeyIndex = 0;

            // --- USER-SPECIFIC DATA STORAGE (Still uses localStorage but keyed by Supabase user ID) ---
            const getUserKey = (key) => {
                if (!app.currentUser) return null;
                // app.currentUser is now the Supabase user ID
                return `pi_new_${app.currentUser}_${key}`;
            };

            const getStoredData = (key) => {
                const userKey = getUserKey(key);
                if (!userKey) return null;
                const data = localStorage.getItem(userKey);
                try {
                    return data ? JSON.parse(data) : null;
                } catch (e) {
                    console.error("Error parsing JSON from localStorage", e);
                    return null;
                }
            };

            const saveStoredData = (key, data) => {
                const userKey = getUserKey(key);
                if (!userKey) return;
                try {
                    localStorage.setItem(userKey, JSON.stringify(data));
                } catch (e) {
                    console.error("Error saving JSON to localStorage", e);
                }
            };

            // --- THEME MANAGEMENT ---
            function applyTheme(theme) {
                const themeBtn = document.getElementById('theme-toggle-btn');
                if (theme === 'dark') {
                    document.body.classList.add('dark-theme');
                    if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">light_mode</span>Mode Terang`;
                } else {
                    document.body.classList.remove('dark-theme');
                    if(themeBtn) themeBtn.innerHTML = `<span class="material-symbols-outlined">dark_mode</span>Mode Gelap`;
                }
            }

            function toggleTheme() {
                const currentTheme = getStoredData('theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                saveStoredData('theme', newTheme);
                applyTheme(newTheme);
            }

            // --- Custom Background ---
            function applyCustomBg(base64String) {
                if (base64String) {
                    const styleEl = document.getElementById('custom-bg-style');
                    styleEl.innerHTML = `#chat-view { background-image: url(${base64String}); }`;
                    document.body.classList.add('custom-bg-active');
                    document.getElementById('menu-remove-bg-btn').style.display = 'flex';
                }
            }

            function removeCustomBg() {
                saveStoredData('custom_bg', null);
                document.getElementById('custom-bg-style').innerHTML = '';
                document.body.classList.remove('custom-bg-active');
                document.getElementById('menu-remove-bg-btn').style.display = 'none';
            }

            function handleCustomBgUpload(event) {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (e) => {
                    const base64String = e.target.result;
                    try {
                        saveStoredData('custom_bg', base64String);
                        applyCustomBg(base64String);
                    } catch (error) {
                        alert('Gagal menyimpan gambar. Ukuran gambar mungkin terlalu besar.');
                        console.error('Error saving custom background:', error);
                    }
                };
                reader.readAsDataURL(file);
            }


            // --- VIEW NAVIGATION ---
            function navigate(viewId) {
                document.querySelectorAll('.view').forEach(view => view.classList.remove('active'));
                const viewElement = document.getElementById(viewId);
                if(viewElement) {
                    viewElement.classList.add('active');
                }
                
                if (viewId === 'chat-view') {
                    stopLoginScreenLogic();
                    setTimeout(() => document.getElementById('chat-input')?.focus(), 100);
                }
                 else if (viewId === 'code-editor-view') {
                    stopLoginScreenLogic();
                    loadCodeProjects();
                    if (app.pendingCodeImport) {
                        handlePendingCodeImport();
                    }
                }
                else if (viewId === 'login-view') {
                    startLoginScreenLogic();
                } else {
                    stopLoginScreenLogic();
                }
            }
            
            // --- DYNAMIC LOGIN BACKGROUND (NEW & IMPROVED) ---
            let loginIntervals = [];
            function startLoginScreenLogic() {
                stopLoginScreenLogic(); // Clear any existing intervals
                const greetingEl = document.getElementById('greeting');
                const clockEl = document.getElementById('clock');
                const backgroundContainer = document.getElementById('background-container');
                const loadingSubtitle = document.querySelector('#loading-view .animated-subtitle');
                
                const images = {
                    pagi: [ // 05:00 - 09:59 (Nature & Calm City)
                        'https://images.unsplash.com/photo-1470252649378-9c29740c9fa8?q=80&w=1920',
                        'https://images.unsplash.com/photo-1448375240586-882707db888b?q=80&w=1920',
                        'https://images.unsplash.com/photo-1500382017468-9049fed747ef?q=80&w=1920',
                        'https://images.unsplash.com/photo-1520443240939-9051a293574a?q=80&w=1920',
                        'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?q=80&w=1920'
                    ],
                    siang: [ // 10:00 - 14:59 (Bright City & Nature)
                        'https://images.unsplash.com/photo-1441974231531-c6227db76b6e?q=80&w=1920',
                        'https://images.unsplash.com/photo-1419242902214-272b3f66ee7a?q=80&w=1920',
                        'https://images.unsplash.com/photo-1533929736458-ca588d08c8be?q=80&w=1920',
                        'https://images.unsplash.com/photo-1497436072909-60f360e1d4b1?q=80&w=1920',
                        'https://images.unsplash.com/photo-1472214103451-9374bd1c798e?q=80&w=1920'
                    ],
                    sore: [ // 15:00 - 18:59 (Sunset & Golden Hour)
                        'https://images.unsplash.com/photo-1426604966848-d7adac402bff?q=80&w=1920',
                        'https://images.unsplash.com/photo-1477346611705-65d1883cee1e?q=80&w=1920',
                        'https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=1920',
                        'https://images.unsplash.com/photo-1485470733090-0aae1788d5af?q=80&w=1920',
                        'https://images.unsplash.com/photo-1560867486-86e195507d8a?q=80&w=1920'
                    ],
                    malam: [ // 19:00 - 04:59 (Night City & Stars)
                        'https://images.unsplash.com/photo-1488866022504-f2584929ca5f?q=80&w=1920',
                        'https://images.unsplash.com/photo-1531218150217-54595bc2b934?q=80&w=1920',
                        'https://images.unsplash.com/photo-1464802686167-b939a6910659?q=80&w=1920',
                        'https://images.unsplash.com/photo-1519904981063-b0cf448d479e?q=80&w=1920',
                        'https://images.unsplash.com/photo-1487017159836-4e23ece2e4cf?q=80&w=1920'
                    ]
                };

                const setDynamicBackground = () => {
                    if (loadingSubtitle) loadingSubtitle.textContent = 'Mempersiapkan latar belakang...';
                    const now = new Date(); 
                    const hour = now.getHours(); 
                    let greeting = ''; 
                    let imageList;
                    if (hour >= 5 && hour < 10) { greeting = 'Selamat Pagi'; imageList = images.pagi; }
                    else if (hour >= 10 && hour < 15) { greeting = 'Selamat Siang'; imageList = images.siang; }
                    else if (hour >= 15 && hour < 19) { greeting = 'Selamat Sore'; imageList = images.sore; }
                    else { greeting = 'Selamat Malam'; imageList = images.malam; }
                    
                    const randomIndex = Math.floor(Math.random() * imageList.length);
                    const imageUrl = imageList[randomIndex];
                    
                    // Preload image to prevent flashing
                    const img = new Image();
                    img.src = imageUrl;
                    img.onload = () => {
                        backgroundContainer.style.backgroundImage = `url('${imageUrl}')`;
                        if (loadingSubtitle) loadingSubtitle.textContent = 'By Paong';
                    };
                    img.onerror = () => {
                        console.error("Gagal memuat gambar latar belakang.");
                        if (loadingSubtitle) loadingSubtitle.textContent = 'By Paong';
                    };

                    greetingEl.textContent = greeting;
                };

                const updateClock = () => {
                    const now = new Date();
                    clockEl.textContent = now.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                };

                setDynamicBackground();
                updateClock();
                loginIntervals.push(setInterval(updateClock, 1000));
                loginIntervals.push(setInterval(setDynamicBackground, 300000)); // Change background every 5 minutes
            }

            function stopLoginScreenLogic() {
                loginIntervals.forEach(clearInterval);
                loginIntervals = [];
            }

            // --- AI RESPONSE STREAMING ---
            function streamMessage(messageContentElement, fullText) {
                messageContentElement.innerHTML = ''; // Clear previous content
                const sanitizedText = fullText.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                const chunks = sanitizedText.split(/(\s+)/g);
                let chunkIndex = 0;
                let animationDelay = 0;

                const processChunk = () => {
                    if (chunkIndex >= chunks.length) {
                        setAIThinking(false); // Re-enable input after streaming is complete
                        return;
                    }

                    const chunk = chunks[chunkIndex];
                    if (chunk) {
                        if (chunk.trim() === '') {
                            const formattedWhitespace = chunk.replace(/\n/g, '<br>');
                            messageContentElement.insertAdjacentHTML('beforeend', formattedWhitespace);
                        } else {
                            let processedWord = chunk.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\*(.*?)\*/g, '<em>$1</em>');
                            const span = document.createElement('span');
                            span.innerHTML = processedWord;
                            span.className = 'word-fade-in';
                            span.style.animationDelay = `${animationDelay * 0.02}s`;
                            messageContentElement.appendChild(span);
                            animationDelay++;
                        }
                    }
                    
                    chunkIndex++;
                    const parentScroller = messageContentElement.closest('.chat-messages');
                    if (parentScroller) {
                        parentScroller.scrollTop = parentScroller.scrollHeight;
                    }
                    
                    setTimeout(processChunk, 30);
                };

                processChunk();
            }


            // --- CHAT MESSAGE HANDLING ---
            function addMessage(sender, content, type = 'text', containerId = 'chat-messages') {
                const chatMessages = document.getElementById(containerId);
                if (!chatMessages) return null;
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}-message`;
                
                let messageContentHTML = '';
                if (type === 'loading') {
                    messageDiv.classList.add('loading-placeholder');
                    messageContentHTML = `<div class="spinner"></div><span>${content}</span>`;
                } else if (type === 'image') {
                    messageContentHTML = `
                        <div class="image-block">
                            <div class="message-content" style="padding:0;">
                                <p style="padding:12px 18px 8px;">Berikut gambar yang Anda minta:</p>
                                <img src="${content}" alt="Generated by AI" onclick="window.app.showImageModal('${content}')">
                            </div>
                            <div class="image-actions">
                                <button onclick="app.downloadGeneratedImage(this)"><span class="material-symbols-outlined">download</span>Download</button>
                            </div>
                        </div>`;
                } else if (type === 'code') {
                    const codeData = JSON.parse(content);
                    const lang = codeData.language || 'text';
                    const code = codeData.code;
                    const encodedCode = code.replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    messageContentHTML = `<div class="message-content">
                        <p>Berikut kode ${lang} yang Anda minta:</p>
                        <div class="code-block">
                            <div class="code-header">
                                <span class="code-lang">${lang}</span>
                                <div class="code-actions">
                                    <button class="preview-code-btn" onclick="app.previewGeneratedCode(this)">Pratinjau</button>
                                    <button class="open-in-editor-btn" onclick="app.openGeneratedCodeInEditor(this)">Buka di Editor</button>
                                    <button class="copy-code-btn" onclick="app.copyCode(this)">Salin</button>
                                </div>
                            </div>
                            <pre><code class="language-${lang}">${encodedCode}</code></pre>
                        </div>
                    </div>`;
                } else {
                    messageContentHTML = `<div class="message-content">${content}</div>`;
                }

                if(type !== 'image') {
                    messageDiv.innerHTML = `<div class="message-header"><span class="material-symbols-outlined">${sender === 'user' ? 'person' : 'smart_toy'}</span><span>${sender === 'user' ? 'Anda' : 'Paong 2.0 Pro'}</span></div>` + messageContentHTML;
                } else {
                     messageDiv.innerHTML = messageContentHTML;
                     messageDiv.style.padding = '0';
                     messageDiv.style.background = 'transparent';
                     messageDiv.style.boxShadow = 'none';
                }
                
                chatMessages.appendChild(messageDiv);
                if (type === 'code') {
                    Prism.highlightAllUnder(messageDiv);
                }
                chatMessages.scrollTop = chatMessages.scrollHeight;
                return messageDiv;
            }
            
            // --- AI THINKING STATE ---
            function setAIThinking(isThinking) {
                isAIThinking = isThinking;
                const chatInput = document.getElementById('chat-input');
                const chatSendBtn = document.getElementById('send-btn');
                const codeInput = document.getElementById('code-generator-input');
                const codeSendBtn = document.getElementById('code-generator-send-btn');

                const shouldDisable = isThinking;

                if (chatInput) chatInput.disabled = shouldDisable;
                if (chatSendBtn) chatSendBtn.disabled = shouldDisable;
                if (codeInput) codeInput.disabled = shouldDisable;
                if (codeSendBtn) codeSendBtn.disabled = shouldDisable;
            }

            // --- API CALLS with FALLBACK/ERROR HANDLING (REFACTORED) ---
            async function queryGemini(history, imageBase64 = null) {
                const model = 'gemini-1.5-flash-latest';
                
                const contents = history.map(msg => ({
                    role: msg.role === 'user' ? 'user' : 'model',
                    parts: [{ text: msg.apiContent }]
                }));

                if (imageBase64) {
                    const lastUserMessage = contents.slice().reverse().find(m => m.role === 'user');
                    if (lastUserMessage) {
                        lastUserMessage.parts.push({
                            inline_data: {
                                mime_type: imageBase64.split(';')[0].split(':')[1],
                                data: imageBase64.split(',')[1]
                            }
                        });
                    }
                }

                for (let i = 0; i < GEMINI_API_KEYS.length; i++) {
                    const keyIndex = (currentGeminiKeyIndex + i) % GEMINI_API_KEYS.length;
                    const currentKey = GEMINI_API_KEYS[keyIndex];
                    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`;

                    try {
                        console.log(`Mencoba Gemini API Key #${keyIndex + 1}...`);
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ contents })
                        });

                        const responseData = await response.json();

                        if (!response.ok) {
                            const errorMessage = responseData.error?.message || `HTTP error! Status: ${response.status}`;
                            throw new Error(errorMessage);
                        }

                        if (responseData.promptFeedback && responseData.promptFeedback.blockReason) {
                            throw new Error(`Permintaan diblokir: ${responseData.promptFeedback.blockReason}`);
                        }
                        
                        if (!responseData.candidates || !responseData.candidates[0].content) {
                            throw new Error("Respons tidak valid dari AI.");
                        }
                        
                        currentGeminiKeyIndex = keyIndex; // Save the working key index
                        return responseData.candidates[0].content.parts[0].text;

                    } catch (error) {
                        console.error(`Gagal dengan Gemini API Key index ${keyIndex}:`, error.message);
                        if (i === GEMINI_API_KEYS.length - 1) {
                            throw new Error(`Semua kunci API Gemini gagal. Kesalahan terakhir: ${error.message}`);
                        }
                    }
                }
            }


            async function generateImageWithStability(prompt) {
                const engineId = 'stable-diffusion-xl-1024-v1-0';
                const url = `https://api.stability.ai/v1/generation/${engineId}/text-to-image`;

                for (let i = 0; i < STABILITY_API_KEYS.length; i++) {
                    const keyIndex = (currentStabilityKeyIndex + i) % STABILITY_API_KEYS.length;
                    const currentKey = STABILITY_API_KEYS[keyIndex];
                    
                    const body = {
                        text_prompts: [{ text: prompt }],
                        cfg_scale: 7,
                        height: 1024,
                        width: 1024,
                        steps: 30,
                        samples: 1,
                        style_preset: "photographic",
                    };

                    try {
                        console.log(`Mencoba Stability API Key #${keyIndex + 1}...`);
                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json',
                                'Authorization': `Bearer ${currentKey}`,
                            },
                            body: JSON.stringify(body),
                        });

                        if (!response.ok) {
                             const errorText = await response.text();
                             throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                        }
                        
                        const responseJSON = await response.json();
                        
                        if (!responseJSON.artifacts || responseJSON.artifacts.length === 0) {
                            throw new Error("API tidak mengembalikan gambar.");
                        }
                        
                        currentStabilityKeyIndex = keyIndex; // Save working key index
                        return `data:image/png;base64,${responseJSON.artifacts[0].base64}`;

                    } catch (error) {
                        console.error(`Gagal dengan Stability API Key #${keyIndex + 1}:`, error.message);
                        if (i === STABILITY_API_KEYS.length - 1) {
                            throw new Error(`Semua kunci API gambar gagal. Kesalahan terakhir: ${error.message}`);
                        }
                    }
                }
            }

            // --- CORE LOGIC ---
            async function sendPromptToAI(prompt, imageBase64 = null) {
                if (isAIThinking) return;
                setAIThinking(true);

                const userMessageContent = imageBase64 ? `<img src="${imageBase64}" class="user-upload-image" alt="User upload" onclick="window.app.showImageModal('${imageBase64}')"><p>${prompt}</p>` : prompt;
                addMessage('user', userMessageContent, 'text');
                saveMessageToHistory('user', prompt, 'text');
                
                const loadingMessage = addMessage('ai', 'Paong 2.0 Pro sedang berpikir...', 'loading');
                
                try {
                    let response;
                    // Use the full message history for context
                    const apiHistory = currentChat.messages;

                    if (prompt.startsWith('/gambar ')) {
                        loadingMessage.querySelector('span').textContent = 'Paong 2.0 Pro sedang membuat gambar...';
                        response = await generateImageWithStability(prompt.substring(8));
                        loadingMessage.remove();
                        addMessage('ai', response, 'image');
                        saveMessageToHistory('ai', response, 'image');
                    } else {
                        loadingMessage.querySelector('span').textContent = imageBase64 ? 'Paong 2.0 Pro sedang menganalisis...' : 'Paong 2.0 Pro sedang berpikir...';
                        response = await queryGemini(apiHistory, imageBase64);
                        loadingMessage.remove();
                        
                        const codeMatch = response.match(/```(\w*)\n([\s\S]*?)```/);
                        if (codeMatch && !imageBase64) {
                            const codeData = { language: codeMatch[1] || 'text', code: codeMatch[2] };
                            const codeDataString = JSON.stringify(codeData);
                            addMessage('ai', codeDataString, 'code');
                            saveMessageToHistory('ai', codeDataString, 'code', codeDataString);
                        } else {
                            const aiMessageDiv = addMessage('ai', '', 'text');
                            streamMessage(aiMessageDiv.querySelector('.message-content'), response);
                            saveMessageToHistory('ai', response);
                        }
                    }
                } catch (error) {
                    console.error("AI Processing Error:", error);
                    loadingMessage.remove();
                    addMessage('ai', `Maaf, terjadi kesalahan: ${error.message}`);
                    saveMessageToHistory('ai', `Error: ${error.message}`);
                } finally {
                    setAIThinking(false);
                }
            }

            async function processUserInput() {
                const input = document.getElementById('chat-input');
                const prompt = input.value.trim();
                if (!prompt && !uploadedImageBase64) return;

                const currentImage = uploadedImageBase64;
                const userPrompt = prompt || "Jelaskan gambar ini.";
                
                await sendPromptToAI(userPrompt, currentImage);
                
                resetImagePreview();
                input.value = '';
                input.style.height = 'auto';
            }

            function saveMessageToHistory(role, apiContent, type = 'text', displayContent = null) {
                if (!currentChat) return;
                const message = { 
                    role, 
                    apiContent, // This is the content sent to/from the API
                    displayContent: displayContent || apiContent, // This is for rendering in the UI
                    type,
                    timestamp: new Date().toISOString()
                };
                currentChat.messages.push(message);
                const allChats = getStoredData('chatHistory') || [];
                const chatIndex = allChats.findIndex(c => c.id === currentChat.id);
                if (chatIndex > -1) {
                    if (allChats[chatIndex].title === "Percakapan Baru" && role === 'user') {
                        const newTitle = apiContent.replace(/<[^>]*>/g, '').substring(0, 30) + (apiContent.length > 30 ? '...' : '');
                        allChats[chatIndex].title = newTitle;
                        currentChat.title = newTitle;
                    }
                    allChats[chatIndex].messages = currentChat.messages;
                    allChats[chatIndex].lastUpdated = new Date().toISOString();
                    saveStoredData('chatHistory', allChats);
                    document.getElementById('chat-title').textContent = currentChat.title;
                }
            }

            function createNewChatAndShow() {
                const allChats = getStoredData('chatHistory') || [];
                const newChat = { id: Date.now().toString(), title: "Percakapan Baru", messages: [], lastUpdated: new Date().toISOString() };
                allChats.unshift(newChat);
                saveStoredData('chatHistory', allChats);
                app.loadChat(newChat.id);
            }

            function renderHistoryList() {
                const historyList = document.getElementById('history-list');
                historyList.innerHTML = '';
                const allChats = getStoredData('chatHistory') || [];
                
                allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

                if (allChats.length === 0) {
                    historyList.innerHTML = '<p style="text-align: center; padding: 20px;">Belum ada riwayat.</p>';
                    return;
                }
                allChats.forEach(chat => {
                    const lastMsg = chat.messages.length > 0 ? chat.messages[chat.messages.length - 1].displayContent : 'Kosong';
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    historyItem.innerHTML = `<div class="history-title">${chat.title}</div><div class="history-preview">${lastMsg.replace(/<[^>]*>/g, '').substring(0,100)}</div><div class="history-actions"><button onclick="window.app.loadChat('${chat.id}')">Buka</button><button onclick="window.app.renameChat('${chat.id}')">Ganti Nama</button><button onclick="window.app.deleteChat('${chat.id}')" style="color:red;">Hapus</button></div>`;
                    historyList.appendChild(historyItem);
                });
            }
            
            // --- AUTHENTICATION (REWORKED FOR SUPABASE) ---
            function showAuthMessage(message, isError = true) {
                const messageBox = document.getElementById('message-box');
                messageBox.textContent = message;
                messageBox.className = `w-full max-w-md p-3 mb-4 text-center text-white rounded-lg ${isError ? 'bg-red-500/50 border border-red-500' : 'bg-green-500/50 border border-green-500'}`;
                messageBox.classList.remove('hidden');
                setTimeout(() => messageBox.classList.add('hidden'), 5000);
            };

            async function handleLogin(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;

                const { error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password,
                });

                if (error) {
                    showAuthMessage(error.message);
                } else {
                    showAuthMessage('Login berhasil! Mengalihkan...', false);
                    // The onAuthStateChange listener will handle navigation
                }
            }

            async function handleRegister(e) {
                e.preventDefault();
                const email = document.getElementById('registerEmail').value;
                const username = document.getElementById('registerUsername').value;
                const password = document.getElementById('registerPassword').value;
                const confirm = document.getElementById('registerConfirm').value;

                if (password.length < 6) { showAuthMessage('Password minimal 6 karakter!'); return; }
                if (password !== confirm) { showAuthMessage('Password tidak cocok!'); return; }
                
                const { data, error } = await supabase.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username // Store username in metadata
                        }
                    }
                });

                if (error) {
                    showAuthMessage(error.message);
                } else {
                    showAuthMessage('Pendaftaran berhasil! Silakan cek email Anda untuk verifikasi.', false);
                    document.getElementById('flipper').classList.remove('is-flipped'); // Flip back to login
                }
            }

            async function handleLogout() {
                if(confirm("Apakah Anda yakin ingin logout?")) {
                    const { error } = await supabase.auth.signOut();
                    if (error) {
                        alert("Gagal logout: " + error.message);
                    }
                    // The onAuthStateChange listener will handle navigation to login page
                }
            }
            
            // --- APP INITIALIZATION LOGIC ---
            function initializeAppUI() {
                if (!app.currentUser) {
                    navigate('login-view');
                    return;
                }
                // Apply color theme
                const savedTheme = getStoredData('theme') || 'light';
                applyTheme(savedTheme);

                // Apply custom background theme
                const savedBg = getStoredData('custom_bg');
                if (savedBg) {
                    applyCustomBg(savedBg);
                } else {
                    removeCustomBg();
                }

                const allChats = getStoredData('chatHistory') || [];
                allChats.sort((a, b) => new Date(b.lastUpdated) - new Date(a.lastUpdated));

                if (allChats.length > 0) {
                    app.loadChat(allChats[0].id);
                } else {
                    createNewChatAndShow();
                }
                // Load code generator history
                loadCodeGeneratorChat();
                // Load code projects
                loadCodeProjects();
            }
            
            // --- UTILS & HELPERS ---
            app.loadChat = (chatId) => {
                const allChats = getStoredData('chatHistory') || [];
                const chatToLoad = allChats.find(c => c.id === chatId);
                if (chatToLoad) {
                    currentChat = chatToLoad;
                    const chatMessages = document.getElementById('chat-messages');
                    chatMessages.innerHTML = '';
                    if(currentChat.messages.length === 0){
                            const welcomeMsg = 'Halo! Saya Paong 2.0 Pro. Ada yang bisa saya bantu? Ketik /gambar untuk membuat gambar atau /kode untuk membuat kode.';
                            const welcomeDiv = addMessage('ai', '', 'text');
                            streamMessage(welcomeDiv.querySelector('.message-content'), welcomeMsg);
                            saveMessageToHistory('ai', welcomeMsg, 'text', welcomeMsg);
                    } else {
                        currentChat.messages.forEach(msg => {
                            let displayContent = msg.displayContent;
                            addMessage(msg.role, msg.type === 'code' ? msg.apiContent : displayContent, msg.type);
                        });
                    }
                    document.getElementById('chat-title').textContent = currentChat.title;
                    navigate('chat-view');
                }
            };
            app.renameChat = (chatId) => {
                const newTitle = prompt('Masukkan judul baru:');
                if (newTitle && newTitle.trim()) {
                    const allChats = getStoredData('chatHistory') || [];
                    const chatIndex = allChats.findIndex(c => c.id === chatId);
                    if (chatIndex > -1) {
                        allChats[chatIndex].title = newTitle.trim();
                        saveStoredData('chatHistory', allChats);
                        renderHistoryList();
                        if (currentChat && currentChat.id === chatId) {
                            document.getElementById('chat-title').textContent = newTitle.trim();
                        }
                    }
                }
            };
            app.deleteChat = (chatId) => {
                if (confirm('Yakin ingin menghapus percakapan ini?')) {
                    let allChats = getStoredData('chatHistory') || [];
                    saveStoredData('chatHistory', allChats.filter(c => c.id !== chatId));
                    renderHistoryList();
                    if (currentChat && currentChat.id === chatId) {
                        initializeAppUI();
                    }
                }
            };
            
            app.downloadGeneratedImage = (buttonEl) => {
                const imageBlock = buttonEl.closest('.image-block');
                const img = imageBlock.querySelector('img');
                const base64String = img.src;

                fetch(base64String)
                    .then(res => res.blob())
                    .then(blob => {
                        downloadFile(blob, `generated_image_${Date.now()}.png`);
                    })
                    .catch(() => alert('Gagal mengunduh gambar.'));
            };

            app.copyCode = (button) => {
                const codeToCopy = button.closest('.code-block').querySelector('code').innerText;
                
                const textArea = document.createElement("textarea");
                textArea.value = codeToCopy;
                
                textArea.style.position = "fixed";
                textArea.style.left = "-9999px";
                
                document.body.appendChild(textArea);
                textArea.select();
                
                try {
                    document.execCommand('copy');
                    const originalText = button.innerHTML;
                    button.innerHTML = 'Tersalin!';
                    setTimeout(() => button.innerHTML = originalText, 2000);
                } catch (err) {
                    console.error('Gagal menyalin teks: ', err);
                    alert('Gagal menyalin teks.');
                }
                
                document.body.removeChild(textArea);
            };
            
            app.showImageModal = (src) => {
                const modalTitle = document.getElementById('modal-title');
                const modalBody = document.getElementById('modal-body');
                modalTitle.textContent = 'Pratinjau Gambar';
                modalBody.innerHTML = `<img src="${src}" style="max-width: 100%; max-height: 80vh; display: block; margin: auto; border-radius: 8px;">`;
                document.getElementById('modal-footer').innerHTML = '';
                document.getElementById('modal').classList.add('visible');
            };

            // --- Code Preview Functionality ---
            app.previewGeneratedCode = (button) => {
                const codeBlock = button.closest('.code-block');
                const code = codeBlock.querySelector('code').innerText;
                const lang = codeBlock.querySelector('.code-lang').innerText.toLowerCase();
                runCodeInFullScreen({ lang, code });
            };
            
            function buildPreview(codeParts) {
                 const { html = '', css = '', js = '' } = codeParts;
                 return `
                    <!DOCTYPE html>
                    <html lang="en">
                    <head>
                        <meta charset="UTF-8">
                        <meta name="viewport" content="width=device-width, initial-scale=1.0">
                        <style>
                            body { font-family: sans-serif; padding: 1rem; color: #111; }
                            ${css}
                        </style>
                    </head>
                    <body>
                        ${html}
                        <script>
                        window.onerror = function(message, source, lineno, colno, error) {
                            document.body.innerHTML = '<pre style="color: red; font-size: 16px;">JavaScript Error:\\n' + message + ' on line ' + lineno + '</pre>';
                        };
                        try {
                            ${js}
                        } catch (e) {
                            document.body.innerHTML = '<pre style="color: red; font-size: 16px;">' + e + '</pre>';
                        }
                        <\/script>
                    </body>
                    </html>
                `;
            }

            function handleImageUpload(file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    uploadedImageBase64 = e.target.result;
                    const thumbnail = document.getElementById('image-preview-thumbnail');
                    thumbnail.src = uploadedImageBase64;
                    document.getElementById('image-preview-container').style.display = 'block';
                };
                reader.readAsDataURL(file);
            }

            function resetImagePreview() {
                uploadedImageBase64 = null;
                document.getElementById('file-input').value = '';
                document.getElementById('image-preview-container').style.display = 'none';
            }
            
            function showReplacePhotoModal() {
                const title = "Ganti Gambar";
                const content = "<p>Pilih sumber gambar baru.</p>";
                const footer = `
                    <button id="replace-from-gallery" class="btn btn-secondary" style="background-color: var(--text-secondary);">Galeri</button>
                    <button id="replace-from-camera" class="btn">Kamera</button>
                `;
                showModal(title, content, footer);
                document.getElementById('replace-from-gallery').onclick = () => {
                    hideModal();
                    document.getElementById('file-input').click();
                };
                document.getElementById('replace-from-camera').onclick = () => {
                    hideModal();
                    startCamera('direct-camera-view', document.getElementById('direct-camera-video'), document.getElementById('direct-camera-canvas'), document.getElementById('capture-direct-controls'), document.getElementById('confirm-direct-controls'));
                };
            }

            function setupCalculator() {
                const currentInputEl = document.getElementById('calculator-current-input');
                const expressionEl = document.getElementById('calculator-expression');
                
                function safeCalculate(expression) {
                    const sanitized = expression.replace(/[^0-9.,+\-*/%()]/g, '').replace(/,/g, '.');
                    try {
                        return new Function('return ' + sanitized)();
                    } catch (e) {
                        return 'Error';
                    }
                }

                document.querySelectorAll('.calc-btn').forEach(button => {
                    button.addEventListener('click', () => {
                        const value = button.textContent;
                        let currentInput = currentInputEl.textContent;
                        
                        if (value === '=') {
                            if (expressionEl.textContent) {
                                const fullExpression = expressionEl.textContent + currentInput;
                                const result = safeCalculate(fullExpression.replace(//g, '*').replace(//g, '/'));
                                currentInputEl.textContent = String(result).replace('.', ',');
                                expressionEl.textContent = '';
                            }
                        } else if (value === 'C') {
                            currentInputEl.textContent = '0';
                            expressionEl.textContent = '';
                        } else if (value === '') {
                            currentInputEl.textContent = currentInput.slice(0, -1) || '0';
                        } else if (['+', '-', '', ''].includes(value)) {
                            expressionEl.textContent += currentInput + value;
                            currentInputEl.textContent = '0';
                        } else {
                            if (currentInput === '0' && value !== ',') {
                                currentInputEl.textContent = value;
                            } else if (!(value === ',' && currentInput.includes(','))) {
                                currentInputEl.textContent += value;
                            }
                        }
                    });
                });
            }
            
            async function handleAiCalculatorUpload(file) {
                const resultDiv = document.getElementById('ai-calculator-result');
                resultDiv.innerHTML = '<div class="spinner" style="margin: 0 auto;"></div><p style="text-align:center;">Paong 2.0 Pro menganalisis gambar...</p>';
                
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const imageBase64 = e.target.result;
                    try {
                        const prompt = "Anda adalah seorang ahli matematika. Analisis gambar ini, identifikasi soal matematika di dalamnya, dan berikan jawaban beserta langkah-langkah dan rumus yang digunakan untuk menyelesaikannya.";
                        const history = [{ role: 'user', apiContent: prompt }];
                        const response = await queryGemini(history, imageBase64);
                        resultDiv.innerHTML = response.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                    } catch (error) {
                        console.error("AI Calculator Error:", error);
                        resultDiv.textContent = `Gagal menganalisis gambar: ${error.message}`;
                    }
                };
                reader.readAsDataURL(file);
            }

            // --- MODAL ---
            function showModal(title, content, footerContent = '', onConfirm = null) {
                document.getElementById('modal-title').textContent = title;
                document.getElementById('modal-body').innerHTML = content;
                document.getElementById('modal-footer').innerHTML = footerContent;
                document.getElementById('modal').classList.add('visible');
                if (onConfirm && document.getElementById('modal-confirm-btn')) {
                    document.getElementById('modal-confirm-btn').onclick = () => {
                        const input = document.getElementById('modal-input');
                        if(input && input.value.trim() === '') {
                            input.focus();
                            return;
                        }
                        hideModal();
                        onConfirm(input ? input.value.trim() : true);
                    };
                }
                 document.getElementById('modal-close-btn').onclick = hideModal;
            }

            function hideModal() {
                document.getElementById('modal').classList.remove('visible');
            }

            // --- CODE GENERATOR LOGIC (REFINED) ---
            async function getAiResponse(history, systemPrompt, imageBase64 = null) {
                const fullHistory = [{ role: 'system', apiContent: systemPrompt }, ...history];
                return await queryGemini(fullHistory, imageBase64);
            }

            function loadCodeGeneratorChat() {
                currentCodeChat = getStoredData('codeGeneratorHistory') || { messages: [] };
                const chatMessages = document.getElementById('code-generator-messages');
                chatMessages.innerHTML = '';
                if (currentCodeChat.messages.length === 0) {
                    const welcomeMsg = 'Selamat datang di Generator Kode! Minta kode apa saja (misalnya "buat game ular dengan javascript"), dan saya akan mengingat percakapan kita di sini untuk perbaikan berkelanjutan.';
                    const welcomeDiv = addMessage('ai', '', 'text', 'code-generator-messages');
                    streamMessage(welcomeDiv.querySelector('.message-content'), welcomeMsg);
                } else {
                    currentCodeChat.messages.forEach(msg => {
                        addMessage(msg.role, msg.apiContent, msg.type, 'code-generator-messages');
                    });
                }
            }

            function saveCodeMessageToHistory(role, apiContent, type = 'text') {
                if (!currentCodeChat) currentCodeChat = { messages: [] }; // Safety check
                const message = { role, apiContent, type, timestamp: new Date().toISOString() };
                currentCodeChat.messages.push(message);
                saveStoredData('codeGeneratorHistory', currentCodeChat);
            }

            async function processCodeInput() {
                if (isAIThinking) return;
                setAIThinking(true);

                const input = document.getElementById('code-generator-input');
                const prompt = input.value.trim();
                if (!prompt) {
                    setAIThinking(false);
                    return;
                }
                
                addMessage('user', prompt, 'text', 'code-generator-messages');
                saveCodeMessageToHistory('user', prompt);
                input.value = '';
                input.style.height = 'auto';

                const loadingMessage = addMessage('ai', 'Paong 2.0 Pro sedang membuat kode...', 'loading', 'code-generator-messages');
                
                try {
                    const systemPrompt = "Anda adalah asisten pembuat kode ahli. Prioritaskan untuk memberikan cuplikan kode yang lengkap, dapat dijalankan, dan dijelaskan dengan baik berdasarkan permintaan pengguna. Selalu bungkus kode Anda dalam blok kode markdown.";
                    const apiHistory = currentCodeChat.messages.map(m => ({ role: m.role, apiContent: m.apiContent }));
                    const response = await queryGemini(apiHistory, systemPrompt);
                    loadingMessage.remove();
                    
                    const codeMatch = response.match(/```(\w*)\n([\s\S]*?)```/);
                    if (codeMatch) {
                        const codeData = { language: codeMatch[1] || 'text', code: codeMatch[2].trim() };
                        const codeDataString = JSON.stringify(codeData);
                        addMessage('ai', codeDataString, 'code', 'code-generator-messages');
                        saveCodeMessageToHistory('ai', codeDataString, 'code');
                    } else {
                        const aiMessageDiv = addMessage('ai', '', 'text', 'code-generator-messages');
                        streamMessage(aiMessageDiv.querySelector('.message-content'), response);
                        saveCodeMessageToHistory('ai', response, 'text');
                    }
                } catch (error) {
                    console.error("Code Gen Error:", error);
                    loadingMessage.remove();
                    addMessage('ai', `Maaf, terjadi kesalahan: ${error.message}`, 'text', 'code-generator-messages');
                    saveCodeMessageToHistory('ai', `Error: ${error.message}`);
                } finally {
                    setAIThinking(false);
                }
            }

            function clearCodeGeneratorHistory() {
                if (confirm('Yakin ingin menghapus seluruh riwayat di Generator Kode?')) {
                    currentCodeChat = { messages: [] };
                    saveStoredData('codeGeneratorHistory', currentCodeChat);
                    loadCodeGeneratorChat();
                }
            }
            
            // --- CODE EDITOR LOGIC ---
            function loadCodeProjects() {
                codeProjects = getStoredData('code_projects') || [];
                renderProjectList();
                if (!currentProject && codeProjects.length > 0) {
                    selectProject(codeProjects[0].id);
                } else if (currentProject) {
                    selectProject(currentProject.id); // Reselect to refresh file list
                } else {
                    renderFileList(); // Clear file list if no projects
                    renderEditorTabs(); // Clear tabs
                    document.getElementById('main-code-editor').value = ''; // Clear editor
                }
            }

            function saveCodeProjects() {
                saveStoredData('code_projects', codeProjects);
            }

            function renderProjectList() {
                const listEl = document.getElementById('project-list');
                listEl.innerHTML = '';
                if (codeProjects.length === 0) {
                    listEl.innerHTML = '<li style="padding: 10px; font-size: 14px; color: var(--text-secondary); text-align: center;">Buat proyek pertama Anda.</li>';
                    return;
                }
                codeProjects.forEach(proj => {
                    const item = document.createElement('li');
                    item.className = 'project-item';
                    item.dataset.id = proj.id;
                    if (currentProject && currentProject.id === proj.id) {
                        item.classList.add('active');
                    }
                    item.innerHTML = `
                        <span>${proj.name}</span>
                        <span class="item-actions">
                            <button class="rename-project-btn" title="Ganti Nama"><span class="material-symbols-outlined" style="font-size: 18px;">edit</span></button>
                            <button class="delete-project-btn" title="Hapus"><span class="material-symbols-outlined" style="font-size: 18px;">delete</span></button>
                        </span>
                    `;
                    item.addEventListener('click', (e) => {
                         if (!e.target.closest('button')) selectProject(proj.id);
                    });
                    item.querySelector('.rename-project-btn').addEventListener('click', () => renameProject(proj.id));
                    item.querySelector('.delete-project-btn').addEventListener('click', () => deleteProject(proj.id));
                    listEl.appendChild(item);
                });
            }
            
            function renderFileList() {
                const listEl = document.getElementById('file-list');
                listEl.innerHTML = '';
                 if (!currentProject) {
                    listEl.innerHTML = '<li style="padding: 10px; font-size: 14px; color: var(--text-secondary); text-align: center;">Pilih proyek untuk melihat berkas.</li>';
                    return;
                }
                if (currentProject.files.length === 0) {
                     listEl.innerHTML = '<li style="padding: 10px; font-size: 14px; color: var(--text-secondary); text-align: center;">Proyek ini kosong.</li>';
                }
                currentProject.files.forEach(file => {
                    const item = document.createElement('li');
                    item.className = 'file-item';
                    item.dataset.name = file.name;
                    if (currentFile && currentFile.name === file.name) {
                        item.classList.add('active');
                    }
                    item.innerHTML = `
                        <span>${file.name}</span>
                         <span class="item-actions">
                            <button class="rename-file-btn" title="Ganti Nama"><span class="material-symbols-outlined" style="font-size: 18px;">edit</span></button>
                            <button class="delete-file-btn" title="Hapus"><span class="material-symbols-outlined" style="font-size: 18px;">delete</span></button>
                        </span>
                    `;
                    item.addEventListener('click', (e) => {
                        if (!e.target.closest('button')) openFileInEditor(currentProject.id, file.name);
                    });
                    item.querySelector('.rename-file-btn').addEventListener('click', () => renameFile(file.name));
                    item.querySelector('.delete-file-btn').addEventListener('click', () => deleteFile(file.name));
                    listEl.appendChild(item);
                });
            }

            function renderEditorTabs() {
                const tabsContainer = document.getElementById('editor-tabs');
                tabsContainer.innerHTML = '';
                openFiles.forEach(fileRef => {
                    const tab = document.createElement('div');
                    tab.className = 'editor-tab';
                    tab.dataset.projectId = fileRef.projectId;
                    tab.dataset.fileName = fileRef.fileName;
                    if (currentFile && currentFile.name === fileRef.fileName && currentProject.id === fileRef.projectId) {
                        tab.classList.add('active');
                    }
                     // Check for JS syntax errors to display indicator
                    const project = codeProjects.find(p => p.id === fileRef.projectId);
                    const file = project?.files.find(f => f.name === fileRef.fileName);
                    if (file && file.name.endsWith('.js')) {
                        try {
                            new Function(file.content); // Check syntax
                        } catch (e) {
                            tab.classList.add('has-error');
                        }
                    }

                    tab.innerHTML = `
                        <span>${fileRef.fileName}</span>
                        <span class="error-indicator">!</span>
                        <button class="close-tab-btn" style="background:none; border:none; color:inherit; cursor:pointer; margin-left:8px; line-height:1;">&times;</button>
                    `;
                    tab.addEventListener('click', (e) => {
                        if (!e.target.classList.contains('close-tab-btn')) {
                            openFileInEditor(fileRef.projectId, fileRef.fileName);
                        }
                    });
                    tab.querySelector('.close-tab-btn').addEventListener('click', () => closeFile(fileRef.projectId, fileRef.fileName));
                    tabsContainer.appendChild(tab);
                });
            }

            function selectProject(projectId) {
                currentProject = codeProjects.find(p => p.id === projectId) || null;
                renderProjectList();
                renderFileList();
                // If the currently open file is not in the new project, clear it
                if (currentFile && currentProject && !currentProject.files.some(f => f.name === currentFile.name)) {
                    clearEditor();
                }
            }

            function openFileInEditor(projectId, fileName) {
                selectProject(projectId); // Ensure correct project is active
                currentFile = currentProject.files.find(f => f.name === fileName);

                if (!openFiles.some(f => f.projectId === projectId && f.fileName === fileName)) {
                    openFiles.push({ projectId, fileName });
                }
                
                const editor = document.getElementById('main-code-editor');
                editor.value = currentFile.content;
                
                renderFileList();
                renderEditorTabs();
            }
            
            function clearEditor() {
                currentFile = null;
                document.getElementById('main-code-editor').value = '';
                renderFileList();
            }

            function closeFile(projectId, fileName) {
                openFiles = openFiles.filter(f => !(f.projectId === projectId && f.fileName === fileName));
                if (currentFile && currentFile.name === fileName && currentProject.id === projectId) {
                    if (openFiles.length > 0) {
                        const lastFile = openFiles[openFiles.length - 1];
                        openFileInEditor(lastFile.projectId, lastFile.fileName);
                    } else {
                        clearEditor();
                    }
                }
                renderEditorTabs();
            }

            function createNewProject() {
                const title = 'Buat Proyek Baru';
                const body = '<p>Masukkan nama untuk proyek baru Anda:</p><input id="modal-input" class="input" type="text" placeholder="Contoh: Website Saya" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">';
                const footer = '<button id="modal-confirm-btn" class="btn">Buat</button>';
                showModal(title, body, footer, (projectName) => {
                    const newProject = {
                        id: 'proj_' + Date.now(),
                        name: projectName,
                        files: [{ name: 'index.html', content: '<h1>Selamat Datang!</h1>\n<p>Ini adalah proyek baru Anda.</p>' }]
                    };
                    codeProjects.unshift(newProject);
                    saveCodeProjects();
                    selectProject(newProject.id);
                    openFileInEditor(newProject.id, 'index.html');
                });
            }

            function renameProject(projectId) {
                const project = codeProjects.find(p => p.id === projectId);
                if (!project) return;
                const title = 'Ganti Nama Proyek';
                const body = `<p>Masukkan nama baru untuk proyek "${project.name}":</p><input id="modal-input" class="input" type="text" value="${project.name}" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">`;
                const footer = '<button id="modal-confirm-btn" class="btn">Simpan</button>';
                showModal(title, body, footer, (newName) => {
                    project.name = newName;
                    saveCodeProjects();
                    renderProjectList();
                });
            }

            function deleteProject(projectId) {
                if (confirm('Yakin ingin menghapus proyek ini beserta semua berkas di dalamnya?')) {
                    codeProjects = codeProjects.filter(p => p.id !== projectId);
                    saveCodeProjects();
                    if (currentProject && currentProject.id === projectId) {
                        currentProject = null;
                        clearEditor();
                    }
                    loadCodeProjects();
                }
            }
            
            function createNewFile() {
                if (!currentProject) {
                    alert("Pilih sebuah proyek terlebih dahulu!");
                    return;
                }
                const title = 'Buat Berkas Baru';
                const body = '<p>Masukkan nama berkas (misal: style.css, script.js):</p><input id="modal-input" class="input" type="text" placeholder="nama.ekstensi" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">';
                const footer = '<button id="modal-confirm-btn" class="btn">Buat</button>';
                showModal(title, body, footer, (fileName) => {
                    if (currentProject.files.some(f => f.name === fileName)) {
                        alert('Berkas dengan nama ini sudah ada.');
                        return;
                    }
                    const newFile = { name: fileName, content: '' };
                    currentProject.files.push(newFile);
                    saveCodeProjects();
                    openFileInEditor(currentProject.id, fileName);
                });
            }

            function renameFile(oldName) {
                if (!currentProject || !currentFile || currentFile.name !== oldName) {
                    alert("Pilih berkas yang ingin diganti namanya terlebih dahulu.");
                    return;
                }
                const title = 'Ganti Nama Berkas';
                const body = `<p>Masukkan nama baru untuk berkas "${oldName}":</p><input id="modal-input" class="input" type="text" value="${oldName}" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">`;
                const footer = '<button id="modal-confirm-btn" class="btn">Simpan</button>';
                showModal(title, body, footer, (newName) => {
                     if (currentProject.files.some(f => f.name === newName)) {
                        alert('Berkas dengan nama ini sudah ada.');
                        return;
                    }
                    // Update openFiles array
                    const openFileRef = openFiles.find(f => f.projectId === currentProject.id && f.fileName === oldName);
                    if (openFileRef) openFileRef.fileName = newName;

                    // Update currentFile and project files array
                    currentFile.name = newName;
                    saveCodeProjects();
                    renderFileList();
                    renderEditorTabs();
                });
            }
            
            function deleteFile(fileName) {
                 if (confirm(`Yakin ingin menghapus berkas "${fileName}"?`)) {
                    currentProject.files = currentProject.files.filter(f => f.name !== fileName);
                    saveCodeProjects();
                    closeFile(currentProject.id, fileName);
                    renderFileList();
                }
            }

            function handleEditorInput(e) {
                if (currentFile && currentProject) {
                    currentFile.content = e.target.value;
                    saveCodeProjects(); // Auto-save on change
                    // Live error checking for JS
                    if (currentFile.name.endsWith('.js')) {
                        const tab = document.querySelector(`.editor-tab[data-file-name="${currentFile.name}"]`);
                        if (tab) {
                            try {
                                new Function(currentFile.content);
                                tab.classList.remove('has-error');
                            } catch (err) {
                                tab.classList.add('has-error');
                            }
                        }
                    }
                }
            }
            
            function runCodeInFullScreen(codeToRun = null) {
                let projectToRun = currentProject;
                let title = projectToRun ? `Pratinjau: ${projectToRun.name}` : 'Pratinjau Kode';
                let files = projectToRun ? projectToRun.files : [];

                if (codeToRun) {
                    // If specific code is passed (from generator), use it
                    const fileExtension = codeToRun.lang === 'javascript' ? 'js' : codeToRun.lang;
                    files = [{ name: `index.${fileExtension || 'html'}`, content: codeToRun.code }];
                    title = 'Pratinjau Kode Generator';
                } else if (!projectToRun) {
                    alert("Tidak ada proyek yang dipilih untuk dijalankan.");
                    return;
                }

                const indexHtmlFile = files.find(f => f.name.toLowerCase() === 'index.html');
                const cssFiles = files.filter(f => f.name.endsWith('.css'));
                const jsFiles = files.filter(f => f.name.endsWith('.js'));
                let finalHtml;

                if (indexHtmlFile) {
                    finalHtml = indexHtmlFile.content;
                    let cssBlock = '';
                    cssFiles.forEach(f => { cssBlock += f.content + '\n'; });
                    finalHtml = finalHtml.replace('</head>', `<style>${cssBlock}</style></head>`);
                    
                    let jsBlock = '';
                    jsFiles.forEach(f => { jsBlock += f.content + '\n'; });
                    const errorHandlingScript = `
                        window.onerror = function(message, source, lineno, colno, error) { document.body.innerHTML = '<pre style="color: red; font-size: 16px; padding: 20px;">RUNTIME ERROR:\\n' + message + ' (line ' + lineno + ')</pre>'; return true; };
                        try { ${jsBlock} } catch (e) { document.body.innerHTML = '<pre style="color: red; font-size: 16px; padding: 20px;">RUNTIME ERROR:\\n' + e + '</pre>'; }
                    `;
                    finalHtml = finalHtml.replace('</body>', `<script>${errorHandlingScript}<\/script></body>`);
                } else if (codeToRun) {
                     const codeMap = { [codeToRun.lang]: codeToRun.code };
                     if (codeToRun.lang === 'javascript') codeMap.js = codeToRun.code;
                     finalHtml = buildPreview(codeMap);
                } else {
                    alert("Proyek ini tidak dapat dijalankan karena tidak memiliki berkas 'index.html'.");
                    return;
                }

                const previewOverlay = document.getElementById('full-preview-overlay');
                const previewIframe = document.getElementById('full-preview-iframe');
                document.getElementById('full-preview-title').textContent = title;
                previewIframe.srcdoc = finalHtml;
                previewOverlay.classList.add('active');
            }

            function closeFullScreenPreview() {
                document.getElementById('full-preview-overlay').classList.remove('active');
                document.getElementById('full-preview-iframe').srcdoc = ''; // Clear content
            }

            function toggleEditorSidebar() {
                const mainContainer = document.getElementById('code-editor-main');
                const toggleBtn = document.getElementById('editor-menu-toggle-btn');
                mainContainer.classList.toggle('sidebar-open');
                if (mainContainer.classList.contains('sidebar-open')) {
                     toggleBtn.innerHTML = `<span class="material-symbols-outlined">close</span>`;
                } else {
                     toggleBtn.innerHTML = `<span class="material-symbols-outlined">menu</span>`;
                }
            }

            function exportProjectAsZip() {
                if (!currentProject) {
                    alert("Pilih proyek yang ingin diekspor.");
                    return;
                }
                if (typeof JSZip === 'undefined') {
                    alert("Gagal memuat library untuk ekspor. Coba lagi nanti.");
                    return;
                }

                const title = "Ekspor Proyek";
                const body = `<p>Proyek akan diunduh sebagai berkas <strong>${currentProject.name}.zip</strong>.</p><p style="margin-top:10px; font-size: 14px;">Perangkat Anda akan meminta lokasi penyimpanan. Anda dapat menggunakan manajer berkas (seperti ZArchiver) untuk membuka dan mengekstrak berkas ZIP tersebut.</p>`;
                const footer = `<button id="modal-confirm-btn" class="btn">Lanjutkan</button>`;

                showModal(title, body, footer, () => {
                    const zip = new JSZip();
                    currentProject.files.forEach(file => {
                        zip.file(file.name, file.content);
                    });

                    zip.generateAsync({ type: "blob" })
                        .then(function(content) {
                            downloadFile(content, `${currentProject.name}.zip`);
                        });
                });
            }
            
            app.openGeneratedCodeInEditor = (button) => {
                const codeBlock = button.closest('.code-block');
                const code = codeBlock.querySelector('code').innerText;
                const lang = codeBlock.querySelector('.code-lang').innerText.toLowerCase();
                
                app.pendingCodeImport = { code, lang };
                navigate('code-editor-view');
            };

            function handlePendingCodeImport() {
                if (!app.pendingCodeImport) return;

                const { code, lang } = app.pendingCodeImport;
                const defaultFileName = `generated-code.${lang || 'txt'}`;

                const title = "Buka di Editor";
                let body = `<p>Pilih proyek untuk menambahkan berkas ini:</p>
                    <select id="project-select" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">
                        ${codeProjects.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                        <option value="new-project">-- Buat Proyek Baru --</option>
                    </select>
                    <p style="margin-top: 15px;">Nama berkas:</p>
                    <input id="modal-input" class="input" type="text" value="${defaultFileName}" style="width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-primary);">`;
                const footer = `<button id="modal-confirm-btn" class="btn">Tambahkan</button>`;

                showModal(title, body, footer, (fileName) => {
                    const selectedProjectId = document.getElementById('project-select').value;
                    
                    const processAndAddFile = (projectId) => {
                        const project = codeProjects.find(p => p.id === projectId);
                        if (!project) return;
                        
                        const existingFile = project.files.find(f => f.name === fileName);
                        if (existingFile) {
                            if (confirm(`Berkas "${fileName}" sudah ada di proyek ini. Timpa isinya?`)) {
                               existingFile.content = code;
                            } else {
                               return; // User cancelled overwrite
                            }
                        } else {
                            project.files.push({ name: fileName, content: code });
                        }
                        saveCodeProjects();
                        setTimeout(() => { 
                            openFileInEditor(projectId, fileName);
                        }, 100);
                    }

                    if (selectedProjectId === 'new-project') {
                        const newProjectName = prompt("Masukkan nama untuk proyek baru:");
                        if (newProjectName) {
                            const newProject = { id: 'proj_' + Date.now(), name: newProjectName, files: [] };
                            codeProjects.unshift(newProject);
                            processAndAddFile(newProject.id);
                        }
                    } else {
                        processAndAddFile(selectedProjectId);
                    }
                });
                
                app.pendingCodeImport = null; // Clear after handling
            }

            // --- CAMERA FEATURES (PRO & DIRECT) ---
            async function startCamera(viewId, videoEl, canvasEl, captureControlsEl, confirmControlsEl) {
                if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                    try {
                        const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                        if (viewId === 'camera-pro-view') cameraPro.stream = stream;
                        else directCameraStream = stream;

                        videoEl.srcObject = stream;
                        videoEl.style.display = 'block';
                        canvasEl.style.display = 'none';
                        captureControlsEl.style.display = 'flex';
                        confirmControlsEl.style.display = 'none';
                        navigate(viewId);
                    } catch (err) {
                        console.error("Error accessing camera: ", err);
                        alert("Tidak bisa mengakses kamera. Pastikan Anda memberikan izin.");
                    }
                } else {
                    alert("Kamera tidak didukung di browser ini.");
                }
            }

            function stopCamera(stream) {
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                return null;
            }

            function capturePhoto(videoEl, canvasEl, captureControlsEl, confirmControlsEl) {
                const ctx = canvasEl.getContext('2d');
                canvasEl.width = videoEl.videoWidth;
                canvasEl.height = videoEl.videoHeight;
                ctx.drawImage(videoEl, 0, 0, canvasEl.width, canvasEl.height);
                
                videoEl.style.display = 'none';
                canvasEl.style.display = 'block';
                captureControlsEl.style.display = 'none';
                confirmControlsEl.style.display = 'flex';
            }

            // --- Education View Logic ---
            function setupEducationView() {
                document.querySelectorAll('.coba-prompt-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const prompt = btn.dataset.prompt;
                        const targetView = btn.dataset.target;
                        
                        const textArea = document.createElement("textarea");
                        textArea.value = prompt;
                        textArea.style.position = "fixed";
                        textArea.style.left = "-9999px";
                        document.body.appendChild(textArea);
                        textArea.select();
                        try {
                            document.execCommand('copy');
                        } catch (err) {
                            console.error('Gagal menyalin prompt: ', err);
                        }
                        document.body.removeChild(textArea);

                        navigate(targetView);
                        setTimeout(() => {
                            const targetInput = document.getElementById(targetView === 'chat-view' ? 'chat-input' : 'code-generator-input');
                            targetInput.value = prompt;
                            targetInput.style.height = 'auto';
                            targetInput.style.height = `${targetInput.scrollHeight}px`;
                            targetInput.focus();
                            alert("Prompt telah disalin dan ditempelkan. Siap untuk dikirim!");
                        }, 200);
                    });
                });
            }
            
            // --- HD ENHANCER (REWORKED) ---
            function setupHDEnhancer() {
                const uploadArea = document.getElementById('enhancer-upload-area');
                const fileInput = document.getElementById('enhancer-file-input');
                const processBtn = document.getElementById('process-enhancer-btn');
                const changeMediaBtn = document.getElementById('change-media-btn');
                
                uploadArea.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        loadMediaForEnhancement(file);
                    }
                });
                
                processBtn.addEventListener('click', processAndExportEnhancedMedia);
                changeMediaBtn.addEventListener('click', () => {
                    resetEnhancerUI();
                    document.getElementById('enhancer-file-input').click();
                });
            }

            function loadMediaForEnhancement(file) {
                resetEnhancerUI(true); // Soft reset before loading new media
                enhancerState.sourceFile = file;
                const url = URL.createObjectURL(file);
                const originalVideo = document.getElementById('enhancer-original-video');
                const originalImage = document.getElementById('enhancer-original-image');
                const stabilizationControl = document.getElementById('stabilization-control-group');
                const previewCanvas = document.getElementById('enhancer-ai-preview');

                enhancerState.previewCanvas = previewCanvas;
                enhancerState.previewCtx = previewCanvas.getContext('2d');
                
                if (file.type.startsWith('video/')) {
                    enhancerState.sourceType = 'video';
                    enhancerState.sourceElement = originalVideo;
                    originalVideo.src = url;
                    originalVideo.style.display = 'block';
                    stabilizationControl.style.display = 'block';

                    originalVideo.onloadedmetadata = () => {
                        setupEnhancerCanvas();
                        originalVideo.play();
                    };
                    originalVideo.onplay = () => startEnhancerPreviewLoop();
                    originalVideo.onpause = () => stopEnhancerPreviewLoop();
                    originalVideo.onended = () => stopEnhancerPreviewLoop();

                } else if (file.type.startsWith('image/')) {
                    enhancerState.sourceType = 'image';
                    enhancerState.sourceElement = originalImage;
                    originalImage.src = url;
                    originalImage.style.display = 'block';
                    stabilizationControl.style.display = 'none';
                    originalImage.onload = () => {
                        setupEnhancerCanvas();
                        startEnhancerPreviewLoop(); // will run once for image
                    };
                }
                
                document.getElementById('enhancer-preview-area').style.display = 'block';
                document.getElementById('enhancer-upload-area').style.display = 'none';
            }

            function setupEnhancerCanvas() {
                const source = enhancerState.sourceElement;
                const canvas = enhancerState.previewCanvas;
                const sourceW = source.videoWidth || source.naturalWidth;
                const sourceH = source.videoHeight || source.naturalHeight;
                
                const container = canvas.parentElement;
                const containerW = container.clientWidth;
                const containerH = container.clientHeight;
                const aspect = sourceW / sourceH;

                let canvasW = containerW;
                let canvasH = canvasW / aspect;
                if (canvasH > containerH) {
                    canvasH = containerH;
                    canvasW = canvasH * aspect;
                }
                canvas.width = canvasW;
                canvas.height = canvasH;
            }
            
            function startEnhancerPreviewLoop() {
                stopEnhancerPreviewLoop(); // Ensure no multiple loops
                
                function loop() {
                    if (!enhancerState.sourceElement) return;
                    // Use simple filters for realtime preview to ensure performance
                    enhancerState.previewCtx.filter = 'saturate(1.2) contrast(1.1)';
                    enhancerState.previewCtx.drawImage(enhancerState.sourceElement, 0, 0, enhancerState.previewCanvas.width, enhancerState.previewCanvas.height);
                    enhancerState.previewCtx.filter = 'none';
                    
                    if (enhancerState.sourceType === 'video' && !enhancerState.sourceElement.paused) {
                        enhancerState.animationFrameId = requestAnimationFrame(loop);
                    }
                }
                enhancerState.animationFrameId = requestAnimationFrame(loop);
            }

            function stopEnhancerPreviewLoop() {
                if (enhancerState.animationFrameId) {
                    cancelAnimationFrame(enhancerState.animationFrameId);
                    enhancerState.animationFrameId = null;
                }
            }
            
            function applyAdvancedAIEffects(sourceCtx, targetCtx, isStabilized, time) {
                const w = sourceCtx.canvas.width;
                const h = sourceCtx.canvas.height;
                targetCtx.clearRect(0, 0, w, h);
                
                // Apply a more noticeable filter combination for export
                targetCtx.filter = 'saturate(1.3) contrast(1.15) brightness(1.05)';
                
                if (isStabilized) {
                    targetCtx.save();
                    const scale = 1.05; // Zoom in slightly
                    const dx = Math.sin(time * 2) * (w * 0.02); // Smooth horizontal pan
                    const dy = Math.cos(time * 2.5) * (h * 0.02); // Smooth vertical pan
                    targetCtx.translate(w / 2, h / 2);
                    targetCtx.scale(scale, scale);
                    targetCtx.translate(-w / 2 - dx, -h / 2 - dy); // Invert pan to stabilize
                    targetCtx.drawImage(sourceCtx.canvas, 0, 0);
                    targetCtx.restore();
                } else {
                     targetCtx.drawImage(sourceCtx.canvas, 0, 0);
                }

                targetCtx.filter = 'none'; // Reset filter
            }

            async function processAndExportEnhancedMedia() {
                if (enhancerState.isRendering) return;
                enhancerState.isRendering = true;

                const processBtn = document.getElementById('process-enhancer-btn');
                const changeBtn = document.getElementById('change-media-btn');
                const statusContainer = document.getElementById('processing-status');
                const progressBar = document.getElementById('processing-progress-bar');
                const statusText = document.getElementById('processing-text');

                processBtn.disabled = true;
                changeBtn.disabled = true;
                statusContainer.style.display = 'flex';
                progressBar.style.width = '0%';
                statusText.textContent = 'Mempersiapkan ekspor...';

                const quality = document.querySelector('input[name="quality"]:checked').value;
                const isStabilized = enhancerState.sourceType === 'video' && document.getElementById('stabilize-toggle').checked;
                
                const source = enhancerState.sourceElement;
                const sourceW = source.videoWidth || source.naturalWidth;
                const sourceH = source.videoHeight || source.naturalHeight;
                const aspect = sourceW / sourceH;
                
                const exportH = parseInt(quality);
                const exportW = Math.round(exportH * aspect);

                const offlineCanvas = document.createElement('canvas');
                offlineCanvas.width = exportW;
                offlineCanvas.height = exportH;
                const offlineCtx = offlineCanvas.getContext('2d');

                const finalCanvas = document.createElement('canvas');
                finalCanvas.width = exportW;
                finalCanvas.height = exportH;
                const finalCtx = finalCanvas.getContext('2d');
                
                if (enhancerState.sourceType === 'image') {
                    statusText.textContent = 'Meningkatkan kualitas gambar...';
                    offlineCtx.drawImage(source, 0, 0, exportW, exportH);
                    applyAdvancedAIEffects(offlineCtx, finalCtx, false, 0);
                    progressBar.style.width = '100%';
                    finalCanvas.toBlob(blob => {
                        downloadFile(blob, `enhanced_${enhancerState.sourceFile.name}`);
                        resetEnhancerUI();
                    }, 'image/jpeg', 0.95);
                } else { // Video processing
                    stopEnhancerPreviewLoop();
                    source.pause();
                    
                    const audioContext = new AudioContext();
                    const sourceNode = audioContext.createMediaElementSource(source);
                    const destinationNode = audioContext.createMediaStreamDestination();
                    
                    const compressor = audioContext.createDynamicsCompressor();
                    compressor.threshold.value = -30;
                    const eq = audioContext.createBiquadFilter();
                    eq.type = 'lowshelf';
                    eq.frequency.value = 250;
                    eq.gain.value = 2;
                    sourceNode.connect(compressor).connect(eq).connect(destinationNode);

                    const videoStream = finalCanvas.captureStream(30);
                    const audioStream = destinationNode.stream;
                    const combinedStream = new MediaStream([...videoStream.getVideoTracks(), ...audioStream.getAudioTracks()]);
                    
                    const recorder = new MediaRecorder(combinedStream, { mimeType: 'video/webm' });
                    const chunks = [];
                    recorder.ondataavailable = e => chunks.push(e.data);
                    recorder.onstop = async () => {
                        const blob = new Blob(chunks, { type: 'video/webm' });
                        downloadFile(blob, `enhanced_${enhancerState.sourceFile.name}.webm`);
                        await audioContext.close();
                        resetEnhancerUI();
                    };
                    
                    source.currentTime = 0;
                    await new Promise(r => source.onseeked = r);
                    recorder.start();

                    let frame = 0;
                    const frameDuration = 1 / 30;

                    async function renderLoop() {
                        if (source.currentTime >= source.duration) {
                            recorder.stop();
                            return;
                        }
                        
                        offlineCtx.drawImage(source, 0, 0, exportW, exportH);
                        applyAdvancedAIEffects(offlineCtx, finalCtx, isStabilized, source.currentTime);

                        const progress = (source.currentTime / source.duration) * 100;
                        progressBar.style.width = `${progress}%`;
                        statusText.textContent = `Memproses... ${Math.round(progress)}%`;

                        source.currentTime = Math.min(source.duration, source.currentTime + frameDuration);
                        await new Promise(resolve => setTimeout(resolve, 1)); // Yield to main thread
                        await new Promise(resolve => source.onseeked = resolve);
                        
                        requestAnimationFrame(renderLoop);
                    }
                    renderLoop();
                }
            }

            function resetEnhancerUI(isSoftReset = false) {
                stopEnhancerPreviewLoop();
                if (enhancerState.sourceElement && enhancerState.sourceType === 'video') {
                    enhancerState.sourceElement.pause();
                    enhancerState.sourceElement.removeAttribute('src');
                    enhancerState.sourceElement.load();
                }
                
                if (!isSoftReset) {
                    document.getElementById('enhancer-file-input').value = '';
                    document.getElementById('enhancer-upload-area').style.display = 'block';
                    document.getElementById('enhancer-preview-area').style.display = 'none';
                }

                enhancerState = { ...enhancerState, isRendering: false };
                document.getElementById('processing-status').style.display = 'none';
                document.getElementById('process-enhancer-btn').disabled = false;
                document.getElementById('change-media-btn').disabled = false;
            }
            
            function downloadFile(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }

            // --- EVENT LISTENERS ---
            function initEventListeners() {
                // Main Sidebar
                document.getElementById('menu-chat-btn').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('menu-code-editor-btn').addEventListener('click', () => navigate('code-editor-view'));
                document.getElementById('menu-code-generator-btn').addEventListener('click', () => navigate('code-generator-view'));
                document.getElementById('menu-hd-enhancer-btn').addEventListener('click', () => navigate('hd-enhancer-view'));
                document.getElementById('menu-camera-pro-btn').addEventListener('click', () => startCamera('camera-pro-view', document.getElementById('camera-pro-video'), document.getElementById('camera-pro-preview-canvas'), document.getElementById('capture-pro-controls'), document.getElementById('confirm-pro-controls')));
                document.getElementById('menu-education-btn').addEventListener('click', () => navigate('education-view'));
                document.getElementById('menu-history-btn').addEventListener('click', () => { renderHistoryList(); navigate('history-view'); });
                document.getElementById('menu-calculator-btn').addEventListener('click', () => navigate('calculator-view'));
                document.getElementById('menu-contact-btn').addEventListener('click', () => navigate('contact-view'));
                document.getElementById('menu-logout-btn').addEventListener('click', handleLogout);
                document.getElementById('theme-toggle-btn').addEventListener('click', toggleTheme);
                document.getElementById('menu-custom-bg-btn').addEventListener('click', () => document.getElementById('custom-bg-input').click());
                document.getElementById('custom-bg-input').addEventListener('change', handleCustomBgUpload);
                document.getElementById('menu-remove-bg-btn').addEventListener('click', removeCustomBg);
                
                // Back Buttons
                document.getElementById('back-to-chat-from-coder').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-chat-from-calculator').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-chat-from-history').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-chat-from-contact').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-main-from-editor').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-main-from-education').addEventListener('click', () => navigate('chat-view'));
                document.getElementById('back-to-main-from-enhancer').addEventListener('click', () => { resetEnhancerUI(); navigate('chat-view'); });

                // Auth
                document.getElementById('loginForm').addEventListener('submit', handleLogin);
                document.getElementById('registerForm').addEventListener('submit', handleRegister);
                document.getElementById('showRegister').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('flipper').classList.add('is-flipped'); });
                document.getElementById('showLogin').addEventListener('click', (e) => { e.preventDefault(); document.getElementById('flipper').classList.remove('is-flipped'); });
                
                // Main Chat
                const chatInput = document.getElementById('chat-input');
                document.getElementById('send-btn').addEventListener('click', processUserInput);
                // *** FIX: Added event listener for the new chat button ***
                document.getElementById('chat-new-chat-btn').addEventListener('click', createNewChatAndShow);
                chatInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processUserInput(); } });
                chatInput.addEventListener('input', () => { chatInput.style.height = 'auto'; chatInput.style.height = `${chatInput.scrollHeight}px`; });
                document.getElementById('upload-btn').addEventListener('click', () => document.getElementById('file-input').click());
                document.getElementById('file-input').addEventListener('change', e => { if (e.target.files[0]) handleImageUpload(e.target.files[0]); });
                document.getElementById('remove-image-btn').addEventListener('click', resetImagePreview);
                document.getElementById('image-preview-thumbnail').addEventListener('click', showReplacePhotoModal);
                
                // Modal & Hamburger
                document.getElementById('modal-close-btn').addEventListener('click', hideModal);
                document.getElementById('hamburger-btn').addEventListener('click', () => document.body.classList.toggle('menu-open'));
                document.getElementById('overlay').addEventListener('click', () => document.body.classList.remove('menu-open'));
                document.querySelectorAll('#sidebar-menu a').forEach(el => el.addEventListener('click', () => document.body.classList.remove('menu-open')));
                
                // Password Toggle
                document.querySelectorAll('.password-toggle').forEach(toggle => {
                    toggle.addEventListener('click', () => {
                        const input = toggle.previousElementSibling;
                        const isVisible = input.type === 'text';
                        input.type = isVisible ? 'password' : 'text';
                        toggle.textContent = isVisible ? 'visibility_off' : 'visibility';
                    });
                });

                // Code Generator
                const codeInput = document.getElementById('code-generator-input');
                document.getElementById('code-generator-send-btn').addEventListener('click', processCodeInput);
                codeInput.addEventListener('keypress', e => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); processCodeInput(); } });
                codeInput.addEventListener('input', () => { codeInput.style.height = 'auto'; codeInput.style.height = `${codeInput.scrollHeight}px`; });
                document.getElementById('code-generator-clear-btn').addEventListener('click', clearCodeGeneratorHistory);

                // Code Editor
                document.getElementById('editor-menu-toggle-btn').addEventListener('click', toggleEditorSidebar);
                document.getElementById('add-project-btn').addEventListener('click', createNewProject);
                document.getElementById('export-project-btn').addEventListener('click', exportProjectAsZip);
                document.getElementById('add-file-btn').addEventListener('click', createNewFile);
                document.getElementById('main-code-editor').addEventListener('input', handleEditorInput);
                document.getElementById('run-code-btn').addEventListener('click', () => runCodeInFullScreen());
                document.getElementById('close-full-preview-btn').addEventListener('click', closeFullScreenPreview);
                document.getElementById('refresh-preview-btn').addEventListener('click', () => runCodeInFullScreen());
                
                // Kamera Pro
                document.getElementById('close-camera-pro-btn').addEventListener('click', () => { cameraPro.stream = stopCamera(cameraPro.stream); navigate('chat-view'); });
                document.getElementById('capture-pro-btn').addEventListener('click', () => capturePhoto(document.getElementById('camera-pro-video'), document.getElementById('camera-pro-preview-canvas'), document.getElementById('capture-pro-controls'), document.getElementById('confirm-pro-controls')));
                document.getElementById('retake-pro-btn').addEventListener('click', () => {
                    document.getElementById('camera-pro-video').style.display = 'block';
                    document.getElementById('camera-pro-preview-canvas').style.display = 'none';
                    document.getElementById('capture-pro-controls').style.display = 'flex';
                    document.getElementById('confirm-pro-controls').style.display = 'none';
                });
                document.getElementById('download-pro-btn').addEventListener('click', () => {
                    const canvas = document.getElementById('camera-pro-preview-canvas');
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = canvas.height;
                    const tempCtx = tempCanvas.getContext('2d');
                    tempCtx.drawImage(canvas, 0, 0);
                    applyAdvancedAIEffects(tempCtx, tempCtx, false, 0);
                    tempCanvas.toBlob(blob => downloadFile(blob, 'Paong_KameraPro.png'), 'image/png');
                });

                // Direct Camera (for chat)
                document.getElementById('direct-camera-btn').addEventListener('click', () => startCamera('direct-camera-view', document.getElementById('direct-camera-video'), document.getElementById('direct-camera-canvas'), document.getElementById('capture-direct-controls'), document.getElementById('confirm-direct-controls')));
                document.getElementById('close-direct-camera-btn').addEventListener('click', () => { directCameraStream = stopCamera(directCameraStream); navigate('chat-view'); });
                document.getElementById('capture-direct-btn').addEventListener('click', () => capturePhoto(document.getElementById('direct-camera-video'), document.getElementById('direct-camera-canvas'), document.getElementById('capture-direct-controls'), document.getElementById('confirm-direct-controls')));
                document.getElementById('retake-direct-btn').addEventListener('click', () => {
                    document.getElementById('direct-camera-video').style.display = 'block';
                    document.getElementById('direct-camera-canvas').style.display = 'none';
                    document.getElementById('capture-direct-controls').style.display = 'flex';
                    document.getElementById('confirm-direct-controls').style.display = 'none';
                });
                document.getElementById('use-photo-btn').addEventListener('click', () => {
                    const canvas = document.getElementById('direct-camera-canvas');
                    uploadedImageBase64 = canvas.toDataURL('image/jpeg', 0.9);
                    document.getElementById('image-preview-thumbnail').src = uploadedImageBase64;
                    document.getElementById('image-preview-container').style.display = 'block';
                    directCameraStream = stopCamera(directCameraStream);
                    navigate('chat-view');
                });


                // Education View
                setupEducationView();
                
                // Calculator
                setupCalculator();
                document.getElementById('ai-calc-upload-btn').addEventListener('click', () => document.getElementById('ai-calc-file-input').click());
                document.getElementById('ai-calc-file-input').addEventListener('change', e => { if (e.target.files[0]) handleAiCalculatorUpload(e.target.files[0]); });

                // HD Enhancer
                setupHDEnhancer();
            }
            
            // --- START THE APP ---
            function startApp() {
                try {
                    initEventListeners();
                    // Supabase auth listener will handle the initial navigation
                    setTimeout(() => {
                        // This timeout is just for the loading animation to be visible
                        // The actual logic is handled by onAuthStateChange
                        const loadingView = document.getElementById('loading-view');
                        if (loadingView.classList.contains('active') && !app.currentUser) {
                           navigate('login-view');
                        }
                    }, 3000);
                } catch (error) {
                    console.error("Fatal error during startup:", error);
                    document.body.innerHTML = `<div style="padding: 20px; text-align: center;"><h1>Aplikasi Gagal Dimuat</h1><p>Terjadi kesalahan fatal. Silakan coba muat ulang halaman.</p><p>Error: ${error.message}</p></div>`;
                }
            }

            // --- NEW: SUPABASE AUTH STATE LISTENER ---
            supabase.auth.onAuthStateChange((event, session) => {
                const loadingView = document.getElementById('loading-view');
                if (session && session.user) {
                    // User is logged in
                    app.currentUser = session.user.id; // Use the stable user ID
                    // Only initialize the main UI if we are not already in it
                    if (loadingView.classList.contains('active') || document.getElementById('login-view').classList.contains('active')) {
                        initializeAppUI();
                    }
                } else {
                    // User is logged out
                    app.currentUser = null;
                    if (!loadingView.classList.contains('active')) {
                        navigate('login-view');
                    }
                }
            });

            startApp();
        });
    </script>
</body>
</html>
